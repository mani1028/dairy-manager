<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dairy Manager Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            900: '#1e3a8a',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; }
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .sidebar-transition { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .btn-hover { transition: all 0.2s; }
        .btn-hover:hover { transform: translateY(-1px); filter: brightness(105%); }
        .btn-hover:active { transform: translateY(0); }
        .row-hover:hover { background-color: #f8fafc; transform: scale-[1.002]; transition: all 0.2s; z-index: 10; position: relative; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        .custom-scrollbar::-webkit-scrollbar { height: 6px; width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .thick-lines table, .thick-lines th, .thick-lines td { border: 2px solid #94a3b8 !important; }
        .thick-lines input { font-weight: 800 !important; color: #1e293b !important; }
        @media print {
            @page { size: landscape; margin: 5mm; }
            .no-print, #sidebar, #loginScreen, #mobileHeader, #toast-container, #dashboard, #customers, #billing, #expenses, #settings, #sidebarOverlay, #confirmModal, button, .chart-btn { display: none !important; }
            body, html { background: white !important; width: 100% !important; height: auto !important; margin: 0 !important; padding: 0 !important; overflow: visible !important; font-size: 10px !important; }
            #mainContent { margin: 0 !important; padding: 0 !important; width: 100% !important; overflow: visible !important; display: block !important; background: white !important; }
            .view-section:not(.hidden) { display: block !important; }
            .overflow-x-auto, .custom-scrollbar, .overflow-hidden { overflow: visible !important; display: block !important; width: 100% !important; height: auto !important; }
            table { width: 100% !important; border-collapse: collapse !important; border: 2px solid #000 !important; table-layout: auto !important; page-break-inside: auto; }
            tr { page-break-inside: avoid; page-break-after: auto; }
            th, td { border: 1px solid #000 !important; padding: 2px 4px !important; font-size: 10px !important; color: black !important; white-space: nowrap; height: auto !important; }
            th { background-color: #eee !important; -webkit-print-color-adjust: exact; font-weight: bold; }
            th:first-child, td:first-child { position: static !important; box-shadow: none !important; width: auto !important; min-width: 100px; text-align: left; }
            input { border: none !important; background: transparent !important; width: 100% !important; text-align: center; font-size: 10px !important; font-weight: bold !important; padding: 0 !important; margin: 0 !important; }
            #printHeader { display: flex !important; justify-content: space-between; align-items: flex-end; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 2px solid #000; }
            .print-only { display: block !important; }
        }
        .print-only { display: none; }
    </style>
</head>
<body class="bg-slate-50 h-screen flex flex-col md:flex-row text-slate-800 overflow-hidden">

    <div id="toast-container" class="fixed bottom-6 right-6 z-[100] flex flex-col gap-3 pointer-events-none"></div>

    <div id="confirmModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden z-[110] flex items-center justify-center p-4 fade-in">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 transform transition-all scale-100 border border-slate-100">
            <div class="text-center mb-6">
                <div id="confirmIcon" class="w-16 h-16 bg-brand-100 text-brand-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl shadow-inner"><i class="fas fa-question"></i></div>
                <h3 class="text-xl font-bold text-slate-800 mb-2" id="confirmTitle">Confirm Action</h3>
                <p class="text-sm text-slate-500 px-4" id="confirmMsg">Are you sure you want to proceed?</p>
            </div>
            <div class="flex gap-3">
                <button onclick="ui.closeConfirm()" class="flex-1 py-3 bg-slate-100 text-slate-700 rounded-xl font-bold hover:bg-slate-200 transition btn-hover">Cancel</button>
                <button id="confirmYesBtn" class="flex-1 py-3 bg-brand-600 text-white rounded-xl font-bold hover:bg-brand-700 transition shadow-lg shadow-brand-200 btn-hover">Yes, Proceed</button>
            </div>
        </div>
    </div>

    <!-- Login/Register Screen -->
    <div id="loginScreen" class="fixed inset-0 bg-slate-900 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md p-8 text-center fade-in relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-500 to-indigo-600"></div>
                <div class="mb-6">
    <div class="h-16 w-16 bg-brand-600 rounded-2xl flex items-center justify-center text-white text-3xl mx-auto mb-4 shadow-lg shadow-brand-200 rotate-3"><i class="fas fa-cow"></i></div>
    <h1 class="text-2xl font-extrabold text-slate-900 tracking-tight">Dairy Manager <span class="text-brand-600">Pro</span></h1>
    
    <p class="text-slate-400 text-sm mt-2 font-medium">Authorized Personnel Only</p>
</div>
                <!-- Toggle Tabs -->
                <div class="flex justify-center gap-4 mt-6 border-b border-slate-100 pb-1">
                    <button onclick="auth.toggleMode('login')" id="tabLogin" class="text-sm font-bold text-brand-600 border-b-2 border-brand-600 pb-2 px-4 transition">Login</button>
                     </div>
            </div>

            <!-- Login Form -->
            <form id="loginForm" onsubmit="auth.login(event)" class="space-y-4 text-left">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1 ml-1">Username</label>
                    <div class="relative"><i class="fas fa-user absolute left-4 top-3.5 text-slate-400"></i><input type="text" id="username" class="w-full border border-slate-200 rounded-xl py-3 pl-11 pr-4 outline-none focus:border-brand-500 focus:ring-4 focus:ring-brand-50 transition" placeholder="admin"></div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1 ml-1">Password</label>
                    <div class="relative"><i class="fas fa-lock absolute left-4 top-3.5 text-slate-400"></i><input type="password" id="password" class="w-full border border-slate-200 rounded-xl py-3 pl-11 pr-4 outline-none focus:border-brand-500 focus:ring-4 focus:ring-brand-50 transition" placeholder="••••••"></div>
                </div>
                <button type="submit" class="w-full bg-brand-600 hover:bg-brand-700 text-white font-bold py-3.5 rounded-xl transition shadow-lg shadow-brand-200 btn-hover mt-2">Sign In</button>
            </form>

            
    <!-- Mobile Header -->
    <div id="mobileHeader" class="md:hidden bg-slate-900 text-white p-4 flex justify-between items-center z-30 shadow-md">
        <div class="flex items-center gap-3"><div class="w-8 h-8 bg-brand-600 rounded-lg flex items-center justify-center text-white text-sm shadow-md"><i class="fas fa-cow"></i></div><span class="font-bold text-lg tracking-wide">Dairy<span class="text-brand-400">Pro</span></span></div>
        <button onclick="app.toggleSidebar()" class="text-white focus:outline-none p-2 rounded hover:bg-slate-800 transition"><i class="fas fa-bars text-xl"></i></button>
    </div>

    <!-- Sidebar -->
    <aside class="fixed md:relative inset-y-0 left-0 w-72 bg-slate-900 text-slate-300 flex-shrink-0 flex flex-col z-40 sidebar-transition -translate-x-full md:translate-x-0 shadow-xl md:shadow-none whitespace-nowrap overflow-hidden" id="sidebar">
        <div class="p-6 flex justify-between items-center h-20 border-b border-slate-800/50">
            <div class="flex items-center gap-3 overflow-hidden"><div class="w-10 h-10 bg-brand-600 rounded-xl flex items-center justify-center text-white text-lg shadow-lg shadow-brand-900 flex-shrink-0"><i class="fas fa-cow"></i></div><div class="flex flex-col sidebar-text"><span class="font-bold text-lg text-white tracking-wide leading-tight" id="sidebarBrandName">DairyMgr</span><span class="text-[10px] font-bold text-brand-400 uppercase tracking-wider">Professional</span></div></div>
            <button onclick="app.toggleSidebar()" class="md:hidden text-slate-400 hover:text-white transition"><i class="fas fa-times text-xl"></i></button>
             <button onclick="app.toggleSidebarDesktop()" class="hidden md:block text-slate-500 hover:text-white focus:outline-none transition" title="Toggle Menu"><i class="fas fa-chevron-left transition-transform duration-300" id="collapseIcon"></i></button>
        </div>
        <nav class="flex-1 overflow-y-auto p-4 space-y-1.5 custom-scrollbar">
            <p class="px-4 text-[10px] font-bold text-slate-500 uppercase mb-2 mt-4 sidebar-text tracking-wider">Operations</p>
            <button onclick="router.navigate('dashboard')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl hover:bg-slate-800/50 hover:text-white text-slate-400 transition btn-hover group" data-target="dashboard"><i class="fas fa-home w-5 text-center group-hover:text-brand-400 transition-colors"></i> <span class="sidebar-text font-medium">Dashboard</span></button>
            <button onclick="router.navigate('orders')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl hover:bg-slate-800/50 hover:text-white text-slate-400 transition btn-hover group" data-target="orders"><i class="fas fa-truck w-5 text-center group-hover:text-brand-400 transition-colors"></i> <span class="sidebar-text font-medium">Orders & Route</span></button>
            <button onclick="router.navigate('customers')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl hover:bg-slate-800/50 hover:text-white text-slate-400 transition btn-hover group" data-target="customers"><i class="fas fa-users w-5 text-center group-hover:text-brand-400 transition-colors"></i> <span class="sidebar-text font-medium">Customers</span></button>
            <p class="px-4 text-[10px] font-bold text-slate-500 uppercase mb-2 mt-6 sidebar-text tracking-wider">Finance</p>
            <button onclick="router.navigate('billing')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl hover:bg-slate-800/50 hover:text-white text-slate-400 transition btn-hover group" data-target="billing"><i class="fas fa-file-invoice-dollar w-5 text-center group-hover:text-brand-400 transition-colors"></i> <span class="sidebar-text font-medium">Billing</span></button>
            <button onclick="router.navigate('expenses')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl hover:bg-slate-800/50 hover:text-white text-slate-400 transition btn-hover group" data-target="expenses"><i class="fas fa-wallet w-5 text-center group-hover:text-brand-400 transition-colors"></i> <span class="sidebar-text font-medium">Expenses</span></button>
            
            <a href="reports.html" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl hover:bg-slate-800/50 hover:text-white text-slate-400 transition btn-hover group"><i class="fas fa-chart-pie w-5 text-center group-hover:text-brand-400 transition-colors"></i> <span class="sidebar-text font-medium">Reports</span></a>
            
            <p class="px-4 text-[10px] font-bold text-slate-500 uppercase mb-2 mt-6 sidebar-text tracking-wider">System</p>
            <button onclick="router.navigate('settings')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl hover:bg-slate-800/50 hover:text-white text-slate-400 transition btn-hover group" data-target="settings"><i class="fas fa-cog w-5 text-center group-hover:text-brand-400 transition-colors"></i> <span class="sidebar-text font-medium">Settings</span></button>
        </nav>
        <div class="p-4 border-t border-slate-800/50 bg-slate-900/50">
            <button onclick="auth.logout()" class="flex items-center space-x-3 px-3 py-2 text-red-400 hover:text-red-300 w-full transition text-sm rounded-lg hover:bg-slate-800" title="Logout"><i class="fas fa-sign-out-alt w-5 text-center flex-shrink-0"></i> <span class="sidebar-text font-medium">Sign Out</span></button>
        </div>
    </aside>

    <main class="flex-1 overflow-y-auto relative bg-slate-50 p-3 md:p-8 w-full custom-scrollbar" id="mainContent">
        <div id="sidebarOverlay" onclick="app.toggleSidebar()" class="fixed inset-0 bg-slate-900/50 z-30 hidden md:hidden backdrop-blur-sm transition-opacity"></div>
        
        <!-- DASHBOARD -->
        <section id="dashboard" class="view-section fade-in">
            <div class="flex flex-col md:flex-row justify-between items-end mb-8 gap-4">
                <div>
                    <h2 class="text-3xl font-bold text-slate-800 tracking-tight" id="dashboardShopTitle">Dashboard</h2>
                    <p class="text-sm text-slate-500 mt-1">Overview for <span id="dashDateLabel" class="font-bold text-slate-700"></span> <span id="todayBadge" class="hidden ml-2 bg-brand-600 text-white text-[10px] font-bold px-2 py-0.5 rounded shadow-sm tracking-wide">TODAY</span></p>
                </div>
                <div class="flex items-center gap-3">
                    <button id="btnBackToday" onclick="app.goToToday()" class="hidden bg-indigo-50 text-indigo-600 px-4 py-2 rounded-xl text-sm font-bold hover:bg-indigo-100 transition shadow-sm btn-hover"><i class="fas fa-calendar-day mr-2"></i>Today</button>
                    <button onclick="app.setDateYesterday()" class="bg-white text-slate-600 border border-slate-200 px-4 py-2 rounded-xl text-sm font-bold hover:bg-slate-50 transition shadow-sm btn-hover">Yesterday</button>
                    <div class="flex items-center bg-white p-1 rounded-xl border border-slate-200 shadow-sm">
                        <button onclick="app.changeDate(-1)" class="p-2 rounded-lg hover:bg-slate-100 text-slate-500 transition"><i class="fas fa-chevron-left"></i></button>
                        <input type="date" id="dashboardDate" class="text-slate-700 text-sm font-bold border-none focus:ring-0 outline-none bg-transparent cursor-pointer w-32 text-center" onchange="app.renderDashboard()">
                        <button onclick="app.changeDate(1)" class="p-2 rounded-lg hover:bg-slate-100 text-slate-500 transition"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5 mb-8">
                <div class="bg-white p-5 rounded-2xl shadow-[0_2px_10px_-4px_rgba(6,81,237,0.1)] border border-slate-100 relative overflow-hidden transition hover:-translate-y-1 hover:shadow-lg">
                    <div class="absolute top-0 left-0 w-1 h-full bg-green-500"></div>
                    <div class="flex justify-between items-start mb-2"><p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Revenue (Finalized)</p><span id="salesPct" class="text-[10px] font-bold px-2 py-0.5 rounded-full bg-gray-100 text-gray-500">0%</span></div>
                    <h3 class="text-3xl font-bold text-slate-800" id="dash-revenue-today">Loading...</h3>
                </div>
                <div class="bg-white p-5 rounded-2xl shadow-[0_2px_10px_-4px_rgba(6,81,237,0.1)] border border-slate-100 relative overflow-hidden transition hover:-translate-y-1 hover:shadow-lg">
                    <div class="absolute top-0 left-0 w-1 h-full bg-blue-500"></div>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Opening Balance (Of Day)</p>
                    <h3 class="text-3xl font-bold text-slate-800" id="dash-dues-prev">Loading...</h3>
                </div>
                <div class="bg-white p-5 rounded-2xl shadow-[0_2px_10px_-4px_rgba(6,81,237,0.1)] border border-slate-100 relative overflow-hidden transition hover:-translate-y-1 hover:shadow-lg">
                    <div class="absolute top-0 left-0 w-1 h-full bg-red-500"></div>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Total Dues (End of Day)</p>
                    <h3 class="text-3xl font-bold text-red-600" id="dash-dues-total">Loading...</h3>
                </div>
                <div class="bg-white p-5 rounded-2xl shadow-[0_2px_10px_-4px_rgba(6,81,237,0.1)] border border-slate-100 relative overflow-hidden transition hover:-translate-y-1 hover:shadow-lg">
                    <div class="absolute top-0 left-0 w-1 h-full bg-purple-500"></div>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Active Customers</p>
                    <h3 class="text-3xl font-bold text-slate-800" id="dash-active-customers">0</h3>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 h-[420px] flex flex-col">
                    <h3 class="font-bold text-slate-800 mb-4 border-b pb-3 flex items-center gap-2"><i class="fas fa-exclamation-circle text-red-500"></i> Top Defaulters</h3>
                    <div class="flex-1 overflow-y-auto pr-2 custom-scrollbar" id="highDuesList"></div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 h-[420px] flex flex-col">
                    <div class="flex justify-between items-center mb-4 border-b pb-3">
                        <h3 class="font-bold text-slate-800 flex items-center gap-2"><i class="fas fa-chart-line text-brand-500"></i> Sales Trend</h3>
                        <div class="flex gap-2 bg-slate-100 p-1 rounded-lg">
                            <button onclick="chartManager.setMode('week')" class="text-xs px-3 py-1 bg-white shadow-sm rounded-md text-slate-800 font-bold chart-btn transition" id="btn-week">Week</button>
                            <button onclick="chartManager.setMode('month')" class="text-xs px-3 py-1 text-slate-500 hover:bg-white hover:shadow-sm rounded-md font-bold chart-btn transition" id="btn-month">Month</button>
                        </div>
                    </div>
                    <div class="relative flex-1 w-full"><canvas id="salesChart"></canvas></div>
                </div>
            </div>
        </section>

        <!-- CUSTOMERS -->
        <section id="customers" class="view-section hidden fade-in">
            <div class="flex justify-between items-center mb-6">
                <div><h2 class="text-2xl font-bold text-slate-800">Customers</h2><p class="text-slate-500 text-sm">Manage your client base</p></div>
                <button onclick="customerManager.openModal()" class="bg-brand-600 hover:bg-brand-700 text-white px-5 py-2.5 rounded-xl font-bold shadow-lg shadow-brand-200 transition btn-hover flex items-center gap-2"><i class="fas fa-plus"></i> <span>Add Customer</span></button>
            </div>
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="p-4 border-b border-slate-100 bg-slate-50 flex flex-col md:flex-row gap-4 justify-between">
                    <div class="relative flex-1"><i class="fas fa-search absolute left-4 top-3.5 text-slate-400"></i><input type="text" id="customerSearch" placeholder="Search by name or phone..." class="w-full pl-11 pr-4 py-3 border border-slate-200 rounded-xl focus:outline-none focus:border-brand-500 focus:ring-4 focus:ring-brand-50 transition text-sm" onkeyup="customerManager.renderList()"></div>
                    <select id="customerSort" class="border border-slate-200 rounded-xl p-3 text-sm focus:outline-none bg-white cursor-pointer hover:border-slate-300" onchange="customerManager.renderList()"><option value="name">Sort by Name</option><option value="dues_high">Sort by Dues (High-Low)</option></select>
                </div>
                <div class="overflow-x-auto custom-scrollbar">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-slate-50 text-slate-500 text-xs uppercase font-bold tracking-wider"><tr><th class="p-4 border-b border-slate-100">Customer Info</th><th class="p-4 border-b border-slate-100">Contact</th><th class="p-4 text-right border-b border-slate-100">Outstanding</th><th class="p-4 text-center border-b border-slate-100">Rates</th><th class="p-4 text-right border-b border-slate-100">Actions</th></tr></thead>
                        <tbody id="customerTableBody" class="divide-y divide-slate-50 text-sm bg-white"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- ORDERS -->
        <section id="orders" class="view-section hidden fade-in">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4 no-print">
                <div><h2 class="text-2xl font-bold text-slate-800">Daily Route</h2><p class="text-slate-500 text-sm">Manage deliveries and print route sheets.</p></div>
                <div class="flex flex-wrap gap-3 items-center">
                    <div class="flex items-center gap-2 bg-white p-1 rounded-xl border border-slate-200 shadow-sm">
                        <button onclick="orderManager.changeDate(-1)" class="p-2 rounded-lg hover:bg-slate-100 text-slate-500 transition"><i class="fas fa-chevron-left"></i></button>
                        <input type="date" id="orderDate" class="text-slate-700 text-sm font-bold border-none focus:ring-0 outline-none bg-transparent cursor-pointer" onchange="orderManager.render()">
                        <button onclick="orderManager.changeDate(1)" class="p-2 rounded-lg hover:bg-slate-100 text-slate-500 transition"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <button onclick="orderManager.fillYesterday()" id="btnCopyPrev" class="bg-indigo-50 text-indigo-700 border border-indigo-100 px-4 py-2.5 rounded-xl hover:bg-indigo-100 transition font-bold text-sm btn-hover"><i class="fas fa-history mr-2"></i>Copy Prev</button>
                    <button onclick="window.print()" class="bg-slate-800 text-white px-4 py-2.5 rounded-xl hover:bg-slate-700 transition font-bold text-sm btn-hover"><i class="fas fa-print mr-2"></i>Print Sheet</button>
                </div>
            </div>
            
            <div id="printHeader" class="print-only mb-6"><div class="text-xl font-bold text-black uppercase tracking-wide">Route Sheet</div><div class="text-sm font-bold text-black">Date: <span id="printDate"></span></div></div>

            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden mb-8 flex flex-col max-w-full">
                <div class="p-4 bg-slate-50 border-b border-slate-200 font-bold text-slate-700 flex justify-between items-center no-print">
                    <div class="flex items-center gap-2">
                         <span>Order List <span class="text-xs font-normal text-slate-500 ml-2" id="orderListDate"></span></span>
                         <button id="unlockOrdersBtn" class="hidden text-brand-600 hover:bg-brand-50 p-2 rounded-lg transition" title="Unlock for Editing" onclick="orderManager.unlockOrders()"><i class="fas fa-lock"></i> <span class="text-xs">Unlock</span></button>
                         <span id="unlockedBadge" class="hidden text-xs text-red-600 font-bold bg-red-100 px-2 py-1 rounded">EDIT MODE</span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="orderManager.saveDraft()" id="btnSaveDraft" class="text-xs bg-white border border-slate-200 text-slate-700 px-3 py-2 rounded-lg hover:bg-slate-50 font-bold transition">Save Changes</button>
                        <button onclick="orderManager.finalizeDay()" id="btnFinalize" class="text-xs bg-green-600 text-white px-3 py-2 rounded-lg hover:bg-green-700 font-bold shadow-sm transition">Finalize</button>
                    </div>
                </div>
                <div class="overflow-x-auto custom-scrollbar w-full thick-lines">
                    <table class="w-full text-left sheet-table min-w-[800px]">
                        <thead class="bg-slate-50 text-slate-600 text-xs uppercase font-bold border-b border-slate-200"><tr id="routeHeaderRow"></tr></thead>
                        <tbody id="orderTableBody" class="divide-y divide-slate-100 text-sm"></tbody>
                        <tfoot id="orderTableFooter" class="bg-slate-100 font-bold text-slate-700 text-sm border-t-2 border-slate-200"></tfoot>
                    </table>
                </div>
            </div>
        </section>

        <!-- BILLING -->
        <section id="billing" class="view-section hidden fade-in">
            <h2 class="text-2xl font-bold text-slate-800 mb-6">Billing & Payments</h2>
            <div class="bg-indigo-50 border border-indigo-100 p-6 rounded-2xl mb-8 flex justify-between items-center shadow-sm relative overflow-hidden">
                <div class="absolute right-0 top-0 w-32 h-32 bg-indigo-100 rounded-full blur-3xl opacity-50 -mr-10 -mt-10"></div>
                <div class="relative z-10"><p class="text-xs font-bold text-indigo-800 uppercase tracking-wider mb-1">Total Collections (This Month)</p><h3 class="text-4xl font-bold text-indigo-600 mt-1" id="billingMonthTotal">₹0</h3></div>
                <div class="text-right text-xs text-indigo-400 font-medium relative z-10"><span id="billingMonthName" class="bg-white/50 px-3 py-1 rounded-full">...</span></div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1 space-y-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                        <h3 class="font-bold text-lg mb-5 text-slate-800 flex items-center"><div class="w-8 h-8 rounded-lg bg-green-100 text-green-600 flex items-center justify-center mr-3 text-sm"><i class="fas fa-hand-holding-usd"></i></div> Record Payment</h3>
                        <form onsubmit="billingManager.recordPayment(event)">
                            <div class="space-y-4">
                                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Customer</label><select id="payCustomer" class="w-full border-slate-200 rounded-xl p-3 bg-slate-50 border focus:border-brand-500 focus:ring-4 focus:ring-brand-50 outline-none transition text-sm" required onchange="billingManager.showDue(this.value)"></select><p id="payCustomerDue" class="text-xs text-red-600 font-bold mt-1 text-right h-4"></p></div>
                                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Amount (₹)</label><input type="number" id="payAmount" min="0" class="w-full border-slate-200 rounded-xl p-3 border focus:border-brand-500 focus:ring-4 focus:ring-brand-50 outline-none transition text-sm font-bold text-slate-700" required></div>
                                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Date</label><input type="date" id="payDate" class="w-full border-slate-200 rounded-xl p-3 border focus:border-brand-500 focus:ring-4 focus:ring-brand-50 outline-none transition text-sm" required></div>
                                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Collected By</label><select id="payCollector" class="w-full border-slate-200 rounded-xl p-3 border focus:border-brand-500 focus:ring-4 focus:ring-brand-50 outline-none transition text-sm"></select></div>
                                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Note</label><input type="text" id="payNote" placeholder="e.g. UPI Ref..." class="w-full border-slate-200 rounded-xl p-3 border focus:border-brand-500 focus:ring-4 focus:ring-brand-50 outline-none transition text-sm"></div>
                                <button type="submit" class="w-full bg-slate-900 hover:bg-slate-800 text-white font-bold py-3.5 rounded-xl transition shadow-lg btn-hover mt-2">Save Payment</button>
                            </div>
                        </form>
                    </div>
                    <div class="bg-gradient-to-br from-blue-50 to-indigo-50 p-6 rounded-2xl border border-blue-100">
                        <h3 class="font-bold text-blue-800 mb-3 flex items-center gap-2"><i class="fas fa-file-invoice"></i> Invoice Generator</h3>
                        <div class="space-y-3"><select id="invoiceCustomer" class="w-full border-blue-200 rounded-xl p-3 text-sm bg-white focus:outline-none"></select><button onclick="billingManager.generateInvoice()" class="w-full bg-brand-600 hover:bg-brand-700 text-white font-bold py-3 rounded-xl transition shadow-md shadow-brand-200 btn-hover">Generate Statement</button></div>
                    </div>
                </div>
                <div class="lg:col-span-2 space-y-6">
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden flex flex-col h-[650px]">
                        <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50"><h3 class="font-bold text-slate-700">Payment History</h3></div>
                        <div class="overflow-y-auto flex-1 custom-scrollbar"><table class="w-full text-left"><thead class="bg-white text-slate-500 text-xs uppercase sticky top-0 shadow-sm z-10"><tr><th class="p-4 bg-slate-50">Date</th><th class="p-4 bg-slate-50">Customer</th><th class="p-4 bg-slate-50">Details</th><th class="p-4 bg-slate-50 text-right">Amount</th></tr></thead><tbody id="paymentHistoryBody" class="divide-y divide-slate-50 text-sm"></tbody></table></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- INVOICE VIEW -->
        <section id="invoice-view" class="view-section hidden bg-white p-10 max-w-4xl mx-auto shadow-xl my-8 print:shadow-none print:w-full print:m-0 rounded-2xl">
            <h2 class="text-3xl font-bold text-slate-900 mb-1">INVOICE / STATEMENT</h2>
            <div class="text-sm text-slate-500 mb-6 flex justify-between items-end">
                <div><div id="inv-date"></div><div class="mt-2 text-slate-600 font-bold">To: <span id="inv-cust-name" class="text-lg text-slate-800"></span></div></div>
                <div class="text-right"><div class="font-bold text-brand-600">Dairy Manager Pro</div><div>+91 98765 43210</div></div>
            </div>
            <div id="invoice-content" class="mb-8"></div>
            <div class="flex justify-end gap-4 no-print mt-8 pt-6 border-t">
                <button onclick="router.navigate('billing')" class="px-5 py-2.5 border border-slate-300 rounded-xl hover:bg-slate-50 font-bold text-slate-600 transition">Back</button>
                <button onclick="billingManager.shareInvoicePDF()" class="px-5 py-2.5 bg-green-500 text-white rounded-xl hover:bg-green-600 flex items-center font-bold shadow-lg shadow-green-200 transition btn-hover"><i class="fab fa-whatsapp mr-2"></i> Share PDF</button>
                <button onclick="window.print()" class="px-5 py-2.5 bg-brand-600 text-white rounded-xl hover:bg-brand-700 font-bold shadow-lg shadow-brand-200 transition btn-hover">Print Invoice</button>
            </div>
        </section>

        <!-- EXPENSES -->
        <section id="expenses" class="view-section hidden fade-in">
            <h2 class="text-2xl font-bold text-slate-800 mb-6">Expense Manager</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 h-fit">
                    <h3 class="font-bold text-lg mb-5 text-slate-800 flex items-center gap-2"><i class="fas fa-plus-circle text-red-500"></i> Add New Expense</h3>
                    <form onsubmit="expenseManager.add(event)" class="space-y-4">
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Description</label><input type="text" id="expTitle" placeholder="e.g., Diesel, Rent" class="w-full border-slate-200 rounded-xl p-3 border focus:border-red-400 focus:ring-4 focus:ring-red-50 outline-none transition text-sm" required></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Category</label><select id="expCategory" class="w-full border-slate-200 rounded-xl p-3 border focus:outline-none text-sm"></select></div>
                            <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Paid To</label><select id="expEmployee" class="w-full border-slate-200 rounded-xl p-3 border focus:outline-none text-sm"><option value="">-- Vendor --</option></select></div>
                        </div>
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Amount (₹)</label><input type="number" id="expAmount" min="0" class="w-full border-slate-200 rounded-xl p-3 border focus:border-red-400 focus:ring-4 focus:ring-red-50 outline-none transition text-sm font-bold" required></div>
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Date</label><input type="date" id="expDate" class="w-full border-slate-200 rounded-xl p-3 border focus:border-red-400 focus:ring-4 focus:ring-red-50 outline-none transition text-sm" required></div>
                        <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3.5 rounded-xl transition shadow-lg shadow-red-200 btn-hover mt-2">Add Expense</button>
                    </form>
                </div>
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden flex flex-col h-[550px]">
                    <div class="p-5 border-b border-slate-100 bg-slate-50 font-bold text-slate-700 flex justify-between items-center">
                        <span>Expense Log</span>
                        <select id="expLogFilter" class="text-xs border rounded-lg p-1.5 font-normal text-slate-500 bg-white" onchange="expenseManager.renderLog()"><option value="">All Staff/Vendors</option></select>
                    </div>
                    <div class="overflow-y-auto flex-1 custom-scrollbar"><table class="w-full text-left"><thead class="bg-white text-slate-500 text-xs uppercase sticky top-0 shadow-sm z-10"><tr><th class="p-4 bg-slate-50">Date</th><th class="p-4 bg-slate-50">Description</th><th class="p-4 bg-slate-50 text-right">Amount</th></tr></thead><tbody id="expenseTableBody" class="divide-y divide-slate-50 text-sm"></tbody></table></div>
                </div>
            </div>
        </section>

        <!-- SETTINGS -->
        <section id="settings" class="view-section hidden fade-in">
            <h2 class="text-2xl font-bold text-slate-800 mb-6">System Settings</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden mb-6">
                    <div class="p-5 border-b border-slate-100 bg-slate-50 flex justify-between items-center"><span class="font-bold text-slate-700">Product Management</span><button onclick="settingsManager.addProduct()" class="text-sm text-brand-600 hover:underline font-bold"><i class="fas fa-plus"></i> Add Product</button></div>
                    <div class="p-6"><div class="grid grid-cols-1 gap-4" id="productSettingsList"></div></div>
                </div>
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden mb-6">
                    <div class="p-5 border-b border-slate-100 bg-slate-50 flex justify-between items-center"><span class="font-bold text-slate-700">Staff Management</span><button onclick="settingsManager.openEmployeeModal()" class="text-sm text-brand-600 hover:underline font-bold"><i class="fas fa-plus"></i> Add Staff</button></div>
                    <div class="p-6"><div class="space-y-3" id="employeeList"></div></div>
                </div>
            </div>
        </section>
    </main>

    <!-- Modals (Customer, Rate, Employee) remain same as before -->
    <div id="customerModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4 fade-in">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg flex flex-col max-h-[90vh]">
            <div class="p-6 border-b bg-slate-50 flex-shrink-0 flex justify-between items-center rounded-t-2xl"><h3 class="font-bold text-lg text-slate-800" id="modalTitle">Add Customer</h3><button onclick="customerManager.closeModal()" class="text-slate-400 hover:text-red-500 transition text-lg"><i class="fas fa-times"></i></button></div>
            <div class="p-6 space-y-5 overflow-y-auto custom-scrollbar">
                <input type="hidden" id="custId">
                <div><label class="block text-xs uppercase font-bold text-slate-500 mb-1">Customer Name</label><input type="text" id="custName" class="w-full border border-slate-200 p-3.5 rounded-xl focus:border-brand-500 focus:ring-4 focus:ring-brand-50 outline-none transition text-sm"></div>
                <div><label class="block text-xs uppercase font-bold text-slate-500 mb-1">Phone Number</label><input type="tel" id="custPhone" class="w-full border border-slate-200 p-3.5 rounded-xl focus:border-brand-500 focus:ring-4 focus:ring-brand-50 outline-none transition text-sm" oninput="customerManager.checkDuplicate(this.value)"><p id="dupWarning" class="text-xs text-orange-600 mt-2 hidden font-medium flex items-center"><i class="fas fa-exclamation-triangle mr-1"></i> Warning: Phone exists!</p></div>
                <div><label class="block text-xs uppercase font-bold text-slate-500 mb-1">Opening Dues (Old Balance)</label><input type="number" id="custDues" placeholder="0" class="w-full border border-slate-200 p-3.5 rounded-xl focus:border-brand-500 focus:ring-4 focus:ring-brand-50 outline-none transition text-sm"></div>
                <div><label class="block text-xs uppercase font-bold text-slate-500 mb-1">Address</label><textarea id="custAddress" class="w-full border border-slate-200 p-3.5 rounded-xl focus:border-brand-500 focus:ring-4 focus:ring-brand-50 outline-none transition text-sm" rows="3"></textarea></div>
                <div class="flex justify-end gap-3 mt-6">
                    <button onclick="customerManager.closeModal()" class="px-6 py-3 text-slate-600 hover:bg-slate-100 rounded-xl font-bold transition">Cancel</button>
                    <button onclick="customerManager.save()" class="px-6 py-3 bg-brand-600 text-white rounded-xl hover:bg-brand-700 font-bold shadow-lg shadow-brand-200 transition btn-hover">Save Details</button>
                </div>
            </div>
        </div>
    </div>

    <!-- RATE MODAL -->
    <div id="rateModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4 fade-in">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md flex flex-col max-h-[90vh]">
            <div class="p-6 border-b bg-slate-50 flex-shrink-0 flex justify-between items-center rounded-t-2xl"><h3 class="font-bold text-lg text-slate-800">Manage Rates</h3><button onclick="document.getElementById('rateModal').classList.add('hidden')" class="text-slate-400 hover:text-red-500 transition text-lg"><i class="fas fa-times"></i></button></div>
            <div class="p-6 overflow-y-auto custom-scrollbar">
                <div class="flex justify-between items-center mb-4"><p class="text-sm text-slate-500">For: <span id="rateCustName" class="font-bold text-slate-800"></span></p></div>
                <input type="hidden" id="rateCustId">
                <div class="grid grid-cols-2 gap-4 mb-2 text-xs font-bold text-slate-500 uppercase"><div>Product</div><div class="text-right">Custom Rate</div></div>
                <div id="rateInputs" class="space-y-3 mb-6"></div>
                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 mb-6">
                    <p class="text-xs font-bold text-blue-800 mb-2 uppercase">Apply To:</p>
                    <div class="space-y-2"><label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="rateScope" value="future" checked class="text-brand-600 focus:ring-brand-500"><span class="text-sm text-slate-700">Tomorrow / Future Orders</span></label><label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="rateScope" value="today" class="text-brand-600 focus:ring-brand-500"><span class="text-sm text-slate-700">Update Today's Orders</span></label></div>
                </div>
                <div class="flex justify-end"><button onclick="customerManager.saveRates()" class="px-6 py-3 bg-brand-600 text-white rounded-xl hover:bg-brand-700 font-bold w-full shadow-lg shadow-brand-200 transition btn-hover">Save Rates</button></div>
            </div>
        </div>
    </div>

    <!-- EMPLOYEE MODAL -->
    <div id="employeeModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4 fade-in">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden">
            <div class="p-6 border-b bg-slate-50 flex justify-between items-center"><h3 class="font-bold text-lg text-slate-800">Add Staff Member</h3><button onclick="settingsManager.closeEmployeeModal()" class="text-slate-400 hover:text-red-500 transition"><i class="fas fa-times"></i></button></div>
            <div class="p-6 space-y-5">
                <div><label class="block text-xs uppercase font-bold text-slate-500 mb-1">Name</label><input type="text" id="empName" class="w-full border border-slate-200 rounded-xl p-3 focus:border-brand-500 focus:ring-4 focus:ring-brand-50 outline-none transition text-sm"></div>
                <div><label class="block text-xs uppercase font-bold text-slate-500 mb-1">Mobile Number</label><input type="tel" id="empPhone" class="w-full border border-slate-200 rounded-xl p-3 focus:border-brand-500 focus:ring-4 focus:ring-brand-50 outline-none transition text-sm"></div>
                <div><label class="block text-xs uppercase font-bold text-slate-500 mb-1">Designation</label><input type="text" id="empRole" class="w-full border border-slate-200 rounded-xl p-3 focus:border-brand-500 focus:ring-4 focus:ring-brand-50 outline-none transition text-sm" placeholder="e.g. Driver"></div>
                <button onclick="settingsManager.saveEmployee()" class="w-full bg-brand-600 text-white py-3 rounded-xl font-bold hover:bg-brand-700 shadow-lg shadow-brand-200 transition btn-hover">Add Staff</button>
            </div>
        </div>
    </div>

    <script>
        // --- FIXED API URL (REMOVED TRAILING SLASH) ---
        const API_BASE = "https://dairy-manager.onrender.com";

        const showToast = (msg, type='success') => { const container = document.getElementById('toast-container'); const toast = document.createElement('div'); const color = type === 'error' ? 'bg-red-500' : 'bg-slate-800'; const icon = type === 'error' ? 'fa-exclamation-circle' : 'fa-check-circle'; toast.className = `${color} text-white px-6 py-4 rounded-xl shadow-xl transform transition-all duration-300 translate-y-10 opacity-0 flex items-center min-w-[320px] pointer-events-auto backdrop-blur-md bg-opacity-95`; toast.innerHTML = `<i class="fas ${icon} mr-3 text-lg"></i> <span class="font-medium">${msg}</span>`; container.appendChild(toast); requestAnimationFrame(() => toast.classList.remove('translate-y-10', 'opacity-0')); setTimeout(() => { toast.classList.add('translate-y-10', 'opacity-0'); setTimeout(() => toast.remove(), 300); }, 3000); };
        const ui = { confirmCallback: null, showConfirm(title, msg, callback) { document.getElementById('confirmTitle').innerText = title; document.getElementById('confirmMsg').innerText = msg; this.confirmCallback = callback; document.getElementById('confirmModal').classList.remove('hidden'); document.getElementById('confirmYesBtn').focus(); }, closeConfirm() { document.getElementById('confirmModal').classList.add('hidden'); this.confirmCallback = null; }, triggerConfirm() { if(this.confirmCallback) this.confirmCallback(); this.closeConfirm(); } }; document.getElementById('confirmYesBtn').onclick = () => ui.triggerConfirm();
        
        const api = {
            getHeaders() {
                const token = localStorage.getItem('dm_token');
                return token ? { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` } : { 'Content-Type': 'application/json' };
            },
            async get(endpoint) {
                try {
                    const res = await fetch(`${API_BASE}${endpoint}`, { headers: this.getHeaders() });
                    if (res.status === 401) { auth.logout(); return null; }
                    return await res.json();
                } catch (e) { showToast('Connection Error', 'error'); return null; }
            },
            async post(endpoint, body) {
                try {
                    const headers = (endpoint === '/api/login' || endpoint === '/api/register') ? { 'Content-Type': 'application/json' } : this.getHeaders();
                    const res = await fetch(`${API_BASE}${endpoint}`, { method: 'POST', headers: headers, body: JSON.stringify(body) });
                    if (res.status === 401 && endpoint !== '/api/login') { auth.logout(); return null; }
                    const data = await res.json();
                    if(data.error) throw new Error(data.error);
                    return data;
                } catch (e) { showToast(e.message, 'error'); return null; }
            },
            async put(endpoint, body) {
                try {
                    const res = await fetch(`${API_BASE}${endpoint}`, { method: 'PUT', headers: this.getHeaders(), body: JSON.stringify(body) });
                    if (res.status === 401) { auth.logout(); return null; }
                    const data = await res.json();
                    if(data.error) throw new Error(data.error);
                    return data;
                } catch (e) { showToast(e.message, 'error'); return null; }
            },
            async del(endpoint) {
                try {
                    const res = await fetch(`${API_BASE}${endpoint}`, { method: 'DELETE', headers: this.getHeaders() });
                    if (res.status === 401) { auth.logout(); return null; }
                    return await res.json();
                } catch (e) { showToast('Connection Error', 'error'); }
            }
        };

        const store = { data: { customers: [], products: [], expenseCategories: ['Operational', 'Purchase', 'Maintenance', 'Salary', 'Advance'], employees: [], orders: [], payments: [], expenses: [] }, async sync() { const data = await api.get('/api/sync'); if (data) { this.data.customers = data.customers || []; this.data.products = data.products || []; this.data.employees = data.employees || []; this.data.payments = data.payments || []; this.data.expenses = data.expenses || []; this.data.orders = data.orders || []; } } };
        const chartManager = { mode: 'week', chart: null, setMode(mode) { this.mode = mode; document.querySelectorAll('.chart-btn').forEach(b => { b.classList.remove('bg-white', 'shadow-sm', 'text-slate-800'); b.classList.add('text-slate-500'); }); document.getElementById(`btn-${mode}`).classList.add('bg-white', 'shadow-sm', 'text-slate-800'); document.getElementById(`btn-${mode}`).classList.remove('text-slate-500'); this.render(document.getElementById('dashboardDate').value); }, render(selectedDateStr) { const ctx = document.getElementById('salesChart'); if(!ctx) return; const selectedDate = new Date(selectedDateStr); const labels = [], dataPoints = []; let daysToFetch = this.mode === 'week' ? 7 : 30; let dateFormat = this.mode === 'week' ? {weekday:'short'} : {day:'numeric', month:'short'}; for(let i=daysToFetch-1; i>=0; i--) { const d = new Date(selectedDate); d.setDate(d.getDate() - i); const dateStr = d.toISOString().split('T')[0]; labels.push(d.toLocaleDateString('en-IN', dateFormat)); const dailyTotal = store.data.orders.filter(o => o.date === dateStr).reduce((sum, o) => sum + o.total, 0); dataPoints.push(dailyTotal); } if(this.chart) this.chart.destroy(); this.chart = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: 'Sales (₹)', data: dataPoints, backgroundColor: '#2563eb', borderRadius: 6 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { display:false } }, x: { grid: { display: false } } } } }); } };
        
        const auth = { 
            toggleMode(mode) {
                if(mode === 'login') {
                    document.getElementById('loginForm').classList.remove('hidden');
                    document.getElementById('registerForm').classList.add('hidden');
                    document.getElementById('tabLogin').classList.add('border-brand-600', 'text-brand-600');
                    document.getElementById('tabLogin').classList.remove('text-slate-400');
                    document.getElementById('tabRegister').classList.remove('border-brand-600', 'text-brand-600');
                    document.getElementById('tabRegister').classList.add('text-slate-400');
                } else {
                    document.getElementById('loginForm').classList.add('hidden');
                    document.getElementById('registerForm').classList.remove('hidden');
                    document.getElementById('tabRegister').classList.add('border-brand-600', 'text-brand-600');
                    document.getElementById('tabRegister').classList.remove('text-slate-400');
                    document.getElementById('tabLogin').classList.remove('border-brand-600', 'text-brand-600');
                    document.getElementById('tabLogin').classList.add('text-slate-400');
                }
            },
            async login(e) { 
                e.preventDefault(); 
                const u = document.getElementById('username').value; 
                const p = document.getElementById('password').value; 
                const res = await api.post('/api/login', {username: u, password: p}); 
                if(res && res.token) { 
                    localStorage.setItem('dm_token', res.token);
                    localStorage.setItem('dm_tenant', res.tenant_id);
                    localStorage.setItem('dm_business_name', res.business_name); // Store Shop Name
                    document.getElementById('loginScreen').classList.add('hidden'); 
                    app.init(); 
                } 
            }, 
            
            async resetDb() {
                if(confirm("DANGER: This will delete ALL data for ALL users. Only do this if you are stuck with schema errors. Continue?")) {
                    const res = await api.get('/api/debug/reset_db');
                    if(res) alert(res.message);
                }
            },
            logout() { 
                localStorage.removeItem('dm_token');
                localStorage.removeItem('dm_tenant');
                localStorage.removeItem('dm_business_name');
                location.reload(); 
            },
            check() {
                if(localStorage.getItem('dm_token')) {
                    document.getElementById('loginScreen').classList.add('hidden');
                    app.init();
                }
            }
        };

        const app = { 
            async init() { 
                // Display Shop Name in Dashboard Title and Sidebar
                const shopName = localStorage.getItem('dm_business_name') || 'Dashboard';
                document.getElementById('dashboardShopTitle').innerText = shopName;
                document.getElementById('sidebarBrandName').innerText = shopName;

                await store.sync(); 
                const today = new Date().toISOString().split('T')[0]; 
                document.getElementById('dashboardDate').value = today; 
                document.getElementById('orderDate').value = today; 
                document.querySelectorAll('input[type="date"]').forEach(el => { if(!el.value) el.value = today; }); 
                await this.fetchOrdersForDate(today); 
                this.renderDashboard(); 
                router.navigate('dashboard'); 
            }, 
            toggleSidebarDesktop() { const sidebar = document.getElementById('sidebar'); const textElements = sidebar.querySelectorAll('.sidebar-text'); const icon = document.getElementById('collapseIcon'); sidebar.classList.toggle('w-72'); sidebar.classList.toggle('w-20'); textElements.forEach(el => el.classList.toggle('hidden')); icon.style.transform = sidebar.classList.contains('w-20') ? 'rotate(180deg)' : 'rotate(0deg)'; }, 
            toggleSidebar() { document.getElementById('sidebar').classList.toggle('-translate-x-full'); document.getElementById('sidebarOverlay').classList.toggle('hidden'); }, 
            async changeDate(days) { const input = document.getElementById('dashboardDate'); const current = new Date(input.value); current.setDate(current.getDate() + days); input.value = current.toISOString().split('T')[0]; await this.fetchOrdersForDate(input.value); this.renderDashboard(); }, 
            async setDateYesterday() { const input = document.getElementById('dashboardDate'); const y = new Date(); y.setDate(y.getDate() - 1); input.value = y.toISOString().split('T')[0]; await this.fetchOrdersForDate(input.value); this.renderDashboard(); }, 
            async fetchOrdersForDate(date) { const orders = await api.get(`/api/orders?date=${date}`); if (orders) { store.data.orders = store.data.orders.filter(o => o.date !== date); store.data.orders.push(...orders); } }, 
            async fetchDashData() { const date = document.getElementById('dashboardDate').value; return await api.get(`/api/dashboard?date=${date}`); }, 
            async renderDashboard() { const dateStr = document.getElementById('dashboardDate').value; const isToday = dateStr === new Date().toISOString().split('T')[0]; document.getElementById('dashDateLabel').innerText = new Date(dateStr).toLocaleDateString('en-IN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }); document.getElementById('todayBadge').classList.toggle('hidden', !isToday); document.getElementById('btnBackToday').classList.toggle('hidden', isToday); const stats = await this.fetchDashData(); if(!stats) return; document.getElementById('dash-revenue-today').innerText = '₹' + stats.revenue_finalized.toLocaleString(); const pctEl = document.getElementById('salesPct'); const pctVal = stats.revenue_pct_change || 0; pctEl.innerText = (pctVal >= 0 ? '+' : '') + pctVal + '%'; pctEl.className = `text-[10px] font-bold px-2 py-0.5 rounded-full ${pctVal >= 0 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`; document.getElementById('dash-dues-prev').innerText = '₹' + stats.opening_balance.toLocaleString(); document.getElementById('dash-dues-total').innerText = '₹' + stats.total_dues.toLocaleString(); document.getElementById('dash-active-customers').innerText = stats.active_customers; chartManager.render(dateStr); const highDuesList = document.getElementById('highDuesList'); highDuesList.innerHTML = ''; const defaulters = store.data.customers.filter(c => c.dues > 0).sort((a,b) => b.dues - a.dues).slice(0, 10); if(defaulters.length === 0) highDuesList.innerHTML = '<div class="text-center text-green-600 p-4 font-bold bg-green-50 rounded-xl">No pending dues!</div>'; else { highDuesList.innerHTML = '<ul class="space-y-3">'; defaulters.forEach(c => { highDuesList.innerHTML += `<li class="flex justify-between items-center bg-slate-50 p-3 rounded-xl border border-slate-100 hover:bg-slate-100 transition"><div class="flex items-center gap-3"><div class="h-9 w-9 rounded-full bg-red-100 text-red-600 flex items-center justify-center font-bold text-xs shadow-sm">${c.name.charAt(0)}</div><span class="font-bold text-slate-700 text-sm">${c.name}</span></div><span class="font-bold text-red-600 text-sm">₹${c.dues.toLocaleString()}</span></li>`; }); highDuesList.innerHTML += '</ul>'; } }, 
            goToToday() { const today = new Date().toISOString().split('T')[0]; document.getElementById('dashboardDate').value = today; this.renderDashboard(); } 
        };
        const router = { navigate(viewId) { document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden')); const target = document.getElementById(viewId); if(target) { target.classList.remove('hidden'); document.querySelectorAll('.nav-item').forEach(el => { const active = el.dataset.target === viewId; if(el.tagName === 'BUTTON') { el.classList.toggle('bg-slate-800', active); el.classList.toggle('text-white', active); el.classList.toggle('shadow-lg', active); } }); if(viewId === 'dashboard') { const today = new Date().toISOString().split('T')[0]; document.getElementById('dashboardDate').value = today; app.renderDashboard(); } if(viewId === 'customers') customerManager.renderList(); if(viewId === 'orders') orderManager.render(); if(viewId === 'billing') billingManager.init(); if(viewId === 'settings') settingsManager.render(); if(viewId === 'expenses') expenseManager.render(); if(window.innerWidth < 768) { document.getElementById('sidebar').classList.add('-translate-x-full'); document.getElementById('sidebarOverlay').classList.add('hidden'); } } } };

        const customerManager = {
            renderList() { const term = document.getElementById('customerSearch').value.toLowerCase(); const sort = document.getElementById('customerSort').value; const tbody = document.getElementById('customerTableBody'); tbody.innerHTML = ''; let list = store.data.customers.filter(c => c.name.toLowerCase().includes(term) || c.phone.includes(term)); if(sort === 'name') list.sort((a,b) => a.name.localeCompare(b.name)); else list.sort((a,b) => b.dues - a.dues); const today = new Date().toISOString().split('T')[0]; list.forEach(c => { const rateStatus = (c.customRates && Object.keys(c.customRates).length > 0) ? `<span class="text-purple-600 font-bold text-xs bg-purple-50 px-2 py-1 rounded-md border border-purple-100">Custom</span>` : `<span class="text-slate-500 font-medium text-xs bg-slate-100 px-2 py-1 rounded-md">Standard</span>`; const duesColor = c.dues > 1000 ? 'text-red-600 bg-red-50 border-red-100' : (c.dues > 0 ? 'text-orange-600 bg-orange-50 border-orange-100' : 'text-green-600 bg-green-50 border-green-100'); const todaysOrder = store.data.orders.find(o => o.customerId === c.id && o.date === today); const todayAmt = todaysOrder ? todaysOrder.total : 0; let prevBalance = c.dues - todayAmt; if (prevBalance < 0) prevBalance = 0; const msg = `Dear ${c.name} (ID: ${c.id}),%0A%0AThank you for your order today worth ₹${todayAmt}.%0AYour previous outstanding balance is ₹${prevBalance}.%0AThis brings your total due to ₹${c.dues}.%0A%0AWe kindly request you to clear the payment at your earliest convenience.%0A%0ABest regards,%0ADurga Dairy Warangal`; const waLink = `https://wa.me/91${c.phone}?text=${msg}`; tbody.innerHTML += `<tr class="row-hover border-b border-slate-50 transition"><td class="p-4"><div class="font-bold text-slate-800">${c.name}</div><div class="text-xs text-slate-400 font-mono">${c.id}</div></td><td class="p-4 text-slate-600"><div>${c.phone}</div><div class="text-xs text-slate-400 truncate w-32">${c.address || '-'}</div></td><td class="p-4 text-right"><span class="font-bold px-3 py-1.5 rounded-lg border ${duesColor}">₹${c.dues}</span></td><td class="p-4 text-center">${rateStatus}</td><td class="p-4 text-right flex justify-end gap-2"><a href="${waLink}" target="_blank" class="text-green-600 bg-green-50 hover:bg-green-100 p-2 rounded-lg transition" title="WhatsApp"><i class="fab fa-whatsapp"></i></a><button onclick="customerManager.openRates('${c.id}')" class="text-purple-600 bg-purple-50 hover:bg-purple-100 p-2 rounded-lg text-xs font-bold transition">Rates</button><button onclick="customerManager.edit('${c.id}')" class="text-blue-600 bg-blue-50 hover:bg-blue-100 p-2 rounded-lg transition" title="Edit Info"><i class="fas fa-edit"></i></button><button onclick="customerManager.delete('${c.id}')" class="text-red-600 bg-red-50 hover:bg-red-100 p-2 rounded-lg transition" title="Delete"><i class="fas fa-trash"></i></button></td></tr>`; }); },
            openModal() { document.getElementById('customerModal').classList.remove('hidden'); document.getElementById('modalTitle').innerText = 'Add New Customer'; document.getElementById('custId').value = ''; document.getElementById('custName').value = ''; document.getElementById('custPhone').value = ''; document.getElementById('custDues').value = ''; document.getElementById('custAddress').value = ''; document.getElementById('dupWarning').classList.add('hidden'); },
            closeModal() { document.getElementById('customerModal').classList.add('hidden'); },
            checkDuplicate(phone) { const match = store.data.customers.find(c => c.phone === phone && c.id !== document.getElementById('custId').value); document.getElementById('dupWarning').classList.toggle('hidden', !match); },
            async save() { const id = document.getElementById('custId').value; const doSave = async () => { const body = { name: document.getElementById('custName').value, phone: document.getElementById('custPhone').value, address: document.getElementById('custAddress').value, dues: parseFloat(document.getElementById('custDues').value || 0) }; if(!body.name || !body.phone) return showToast("Name and Phone required", 'error'); let res; if (id) res = await api.put(`/api/customers/${id}`, body); else res = await api.post('/api/customers', body); if(res) { await store.sync(); this.closeModal(); this.renderList(); showToast('Customer Saved Successfully'); } }; if(id) { ui.showConfirm('Save Changes?', 'Are you sure you want to update this customer\'s details?', doSave); } else { await doSave(); } },
            edit(id) { ui.showConfirm('Edit Customer?', 'Are you sure you want to modify this customer\'s information?', () => { const c = store.data.customers.find(c => c.id === id); if(!c) return; this.openModal(); document.getElementById('modalTitle').innerText = 'Edit Customer'; document.getElementById('custId').value = c.id; document.getElementById('custName').value = c.name; document.getElementById('custPhone').value = c.phone; document.getElementById('custAddress').value = c.address; document.getElementById('custDues').value = c.dues; }); },
            delete(id) { ui.showConfirm('Delete Customer?', 'This action cannot be undone. Are you sure?', async () => { await api.del(`/api/customers/${id}`); await store.sync(); this.renderList(); showToast('Customer Deleted'); }); },
            openRates(id) { const c = store.data.customers.find(c => c.id === id); document.getElementById('rateModal').classList.remove('hidden'); document.getElementById('rateCustName').innerText = c.name; document.getElementById('rateCustId').value = c.id; const container = document.getElementById('rateInputs'); container.innerHTML = ''; store.data.products.forEach(p => { const currentRate = (c.customRates && c.customRates[p.id]) ? c.customRates[p.id] : ''; const isCustom = currentRate !== '' && currentRate != p.price; container.innerHTML += `<div class="flex justify-between items-center bg-white p-3 rounded-lg border ${isCustom ? "border-brand-500 bg-blue-50" : "border-slate-200"}"><div><div class="font-bold text-sm text-slate-700">${p.name}</div><div class="text-xs font-semibold text-slate-400">Standard Rate: ₹${p.price}</div></div><div class="flex flex-col items-end"><span class="text-[10px] text-slate-500 uppercase font-extrabold mb-1">${isCustom ? 'Custom Rate' : 'Standard'}</span><div class="flex items-center gap-1"><span class="text-sm font-bold text-slate-600">₹</span><input id="rate_${p.id}" type="number" value="${currentRate}" placeholder="${p.price}" class="w-20 border border-slate-300 rounded p-1 text-center text-sm font-bold text-slate-800 focus:border-brand-500 focus:ring-2 focus:ring-brand-100 outline-none"></div></div></div>`; }); },
            async saveRates() { const cid = document.getElementById('rateCustId').value; const scope = document.querySelector('input[name="rateScope"]:checked').value; const rates = {}; store.data.products.forEach(p => { const val = document.getElementById(`rate_${p.id}`).value; if(val && val !== '') rates[p.id] = parseFloat(val); }); const res = await api.post(`/api/customers/${cid}/rates`, { rates, scope }); if(res) { showToast(res.message); await store.sync(); await app.fetchOrdersForDate(document.getElementById('orderDate').value); document.getElementById('rateModal').classList.add('hidden'); this.renderList(); } }
        };

        const orderManager = {
            isLocked: false,
            // Stores visible columns for the current view
            currentVisibleProducts: [], 
            async render() {
                const dateInput = document.getElementById('orderDate').value;
                const selectedDate = new Date(dateInput);
                const today = new Date(); today.setHours(0,0,0,0); selectedDate.setHours(0,0,0,0);
                
                document.getElementById('printDate').innerText = selectedDate.toLocaleDateString('en-IN', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' });
                document.getElementById('orderListDate').innerText = `For: ${selectedDate.toLocaleDateString()}`;
                
                await app.fetchOrdersForDate(dateInput); 
                
                // Logic: Sheet is Locked ONLY if status is 'finalized'. 
                // Unlocked by default for past, present, and future until finalized.
                const isFinalized = store.data.customers.some(c => { 
                    const o = store.data.orders.find(ord => ord.customerId === c.id && ord.date === dateInput); 
                    return o && o.status === 'finalized'; 
                });
                
                this.isLocked = isFinalized; 
                this.updateLockUI();

                // SMART COLUMNS LOGIC:
                // Show product IF: 
                // 1. Product is Active (isActive !== false)
                // 2. OR Product is Inactive BUT has quantities > 0 for ANY customer on THIS date (Historical View)
                this.currentVisibleProducts = store.data.products.filter(p => {
                    if (p.isActive !== false) return true; // Active products always shown
                    // For inactive products, check if they are used in this day's orders
                    const isUsed = store.data.customers.some(c => {
                        const order = store.data.orders.find(o => o.customerId === c.id && o.date === dateInput);
                        if (!order || !order.items) return false;
                        const item = order.items.find(i => i.id === p.id || i.name === p.name);
                        return item && item.quantity > 0;
                    });
                    return isUsed;
                });

                const h = document.getElementById('routeHeaderRow');
                h.innerHTML = '<th class="p-3 w-32 sticky left-0 bg-slate-50 z-10 text-left border-r border-slate-200 shadow-sm">Customer</th>' + 
                              this.currentVisibleProducts.map(p => `<th class="p-2 w-16 text-center text-xs font-bold break-words leading-tight border-r border-slate-100">${p.name}</th>`).join('') + 
                              '<th class="p-4 text-center no-print">Status</th>';
                
                const tbody = document.getElementById('orderTableBody'); tbody.innerHTML = '';
                
                store.data.customers.forEach((c, cIdx) => {
                    const order = store.data.orders.find(o => o.customerId === c.id && o.date === dateInput);
                    // Generate inputs only for visible products
                    const inputs = this.currentVisibleProducts.map((p, pIdx) => {
                         let qty = '';
                         if(order && order.items) {
                             let item = order.items.find(i => i.id === p.id);
                             if(!item) item = order.items.find(i => i.name === p.name); // Legacy Fallback
                             if(item) qty = item.quantity;
                         }
                         return `<td class="p-0 border-r border-slate-50"><input type="number" id="ord_${c.id}_${p.id}" ${this.isLocked ? 'disabled' : ''} min="0" value="${qty}" class="w-full border-0 border-b-2 border-transparent hover:border-slate-200 focus:border-brand-500 rounded-none text-center py-2 bg-transparent focus:bg-brand-50 quantity-input text-sm font-bold h-10 transition-colors ${this.isLocked ? 'text-slate-400 cursor-not-allowed' : ''}" data-pid="${p.id}" data-row="${cIdx}" data-col="${pIdx}" oninput="orderManager.updateTotals()" onkeydown="orderManager.handleKeyNav(event, this)"></td>`
                    }).join('');
                    
                    const status = order ? (order.status === 'finalized' ? `<span class="text-xs font-bold text-green-600 bg-green-100 px-2 py-1 rounded">Finalized</span>` : `<span class="text-xs font-bold text-blue-600 bg-blue-100 px-2 py-1 rounded">Draft</span>`) : `<span class="text-xs text-slate-400">Pending</span>`;
                    tbody.innerHTML += `<tr class="border-b border-slate-50 hover:bg-slate-50"><td class="p-3 sticky left-0 bg-white z-10 border-r border-slate-200 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.05)]"><div class="font-bold text-slate-700 text-sm whitespace-nowrap">${c.name}</div></td>${inputs}<td class="p-4 text-center w-24 no-print" id="status_${c.id}">${status}</td></tr>`;
                });
                this.updateTotals();
            },
            updateLockUI() {
                const btnSave = document.getElementById('btnSaveDraft'); const btnFinal = document.getElementById('btnFinalize'); const btnUnlock = document.getElementById('unlockOrdersBtn'); const btnCopy = document.getElementById('btnCopyPrev'); const badge = document.getElementById('unlockedBadge');
                if(this.isLocked) { btnSave.classList.add('hidden'); btnFinal.classList.add('hidden'); btnCopy.classList.add('hidden'); btnUnlock.classList.remove('hidden'); badge.classList.add('hidden'); } 
                else { btnSave.classList.remove('hidden'); btnFinal.classList.remove('hidden'); btnCopy.classList.remove('hidden'); btnUnlock.classList.add('hidden'); badge.classList.remove('hidden'); }
            },
            unlockOrders() {
                ui.showConfirm("Unlock Orders?", "Editing finalized orders will recalculate customer ledgers automatically. Proceed?", () => {
                    this.isLocked = false;
                    this.updateLockUI();
                    document.querySelectorAll('.quantity-input').forEach(inp => { inp.disabled = false; inp.classList.remove('text-slate-400', 'cursor-not-allowed'); });
                    showToast("Editing Enabled");
                });
            },
            handleKeyNav(e, el) {
                if(e.key.startsWith('Arrow')) { e.preventDefault(); const currentRow = parseInt(el.dataset.row); const currentCol = parseInt(el.dataset.col); const totalRows = store.data.customers.length; const totalCols = this.currentVisibleProducts.length; let targetRow = currentRow, targetCol = currentCol; if(e.key === 'ArrowUp') targetRow = Math.max(0, currentRow - 1); if(e.key === 'ArrowDown') targetRow = Math.min(totalRows - 1, currentRow + 1); if(e.key === 'ArrowLeft') targetCol = Math.max(0, currentCol - 1); if(e.key === 'ArrowRight') targetCol = Math.min(totalCols - 1, currentCol + 1); const targetEl = document.querySelector(`.quantity-input[data-row="${targetRow}"][data-col="${targetCol}"]`); if(targetEl) { targetEl.focus(); targetEl.select(); } }
            },
            async changeDate(days) { const input = document.getElementById('orderDate'); const current = new Date(input.value); current.setDate(current.getDate() + days); input.value = current.toISOString().split('T')[0]; this.render(); },
            updateTotals() {
                // Only calculate totals for visible products
                const totals = {}; this.currentVisibleProducts.forEach(p => totals[p.id] = 0);
                document.querySelectorAll('.quantity-input').forEach(input => { const pid = input.dataset.pid; if(totals[pid] !== undefined) totals[pid] += (parseInt(input.value) || 0); });
                let footerHtml = '<tr class="bg-slate-100 font-bold sticky bottom-0 z-20"><td class="p-3 text-right sticky left-0 bg-slate-100 border-r border-slate-200">Total:</td>';
                this.currentVisibleProducts.forEach(p => footerHtml += `<td class="p-2 text-center text-brand-600 text-sm border-r border-slate-200">${totals[p.id]}</td>`);
                document.getElementById('orderTableFooter').innerHTML = footerHtml + '<td class="no-print"></td></tr>';
            },
            async fillYesterday() {
                const date = document.getElementById('orderDate').value; const d = new Date(date); d.setDate(d.getDate() - 1); const prevDate = d.toISOString().split('T')[0]; const prevOrders = await api.get(`/api/orders?date=${prevDate}`); if (!prevOrders || prevOrders.length === 0) return showToast("No orders found for previous day", "error");
                prevOrders.forEach(order => { order.items.forEach(item => { const prod = store.data.products.find(p => p.name === item.name); if(prod) { const input = document.getElementById(`ord_${order.customerId}_${prod.id}`); if(input) input.value = item.quantity; } }); });
                this.updateTotals(); showToast("Filled from history");
            },
            async saveDraft() { await this.submitOrders('draft'); },
            async finalizeDay() { ui.showConfirm('Finalize Orders?', 'This will update customer ledgers and lock the sheet.', async () => await this.submitOrders('finalized')); },
            async submitOrders(status) {
                const date = document.getElementById('orderDate').value;
                const ordersToSave = [];
                store.data.customers.forEach(c => {
                    const items = []; let total = 0;
                    // Iterate through VISIBLE products to save what's on screen. 
                    // Note: If a product is hidden (deleted + no historical data), it won't be saved here, which is correct (removes the record).
                    this.currentVisibleProducts.forEach(p => { 
                        const input = document.getElementById(`ord_${c.id}_${p.id}`);
                        const q = parseInt(input?.value || 0); 
                        if(q > 0) { 
                            const price = (c.customRates && c.customRates[p.id]) ? c.customRates[p.id] : p.price; 
                            items.push({ productId: p.id, name: p.name, quantity: q, price }); 
                            total += q * price; 
                        } 
                    });
                    if(items.length > 0) {
                         ordersToSave.push({ id: `ORD-${Date.now()}-${c.id}`, customerId: c.id, customerName: c.name, items, total, status });
                    }
                });
                if(ordersToSave.length === 0) return showToast("No orders to save", "error");
                const res = await api.post('/api/orders/save', { date, orders: ordersToSave });
                if(res) { 
                    showToast(`${status === 'draft' ? 'Draft Saved' : 'Finalized'}: ${res.message}`); 
                    await store.sync(); 
                    await this.render(); 
                }
            }
        };

        const billingManager = {
            init() { const paySel = document.getElementById('payCustomer'), invSel = document.getElementById('invoiceCustomer'); let opts = '<option value="">Select Customer</option>'; store.data.customers.forEach(c => opts += `<option value="${c.id}">${c.name} (Due: ₹${c.dues})</option>`); paySel.innerHTML = invSel.innerHTML = opts; const colSel = document.getElementById('payCollector'); colSel.innerHTML = '<option value="">-- Self / Owner --</option>'; store.data.employees.forEach(e => colSel.innerHTML += `<option value="${e.name}">${e.name} (${e.role})</option>`); this.renderHistory(); },
            showDue(cid) { const c = store.data.customers.find(x => x.id === cid); document.getElementById('payCustomerDue').innerText = (c && c.dues > 0) ? `Current Pending: ₹${c.dues}` : ''; },
            renderHistory() { const tbody = document.getElementById('paymentHistoryBody'); tbody.innerHTML = ''; const sortedPayments = [...store.data.payments].sort((a, b) => new Date(b.date) - new Date(a.date)); const grouped = {}; sortedPayments.forEach(p => { const d = new Date(p.date); const key = d.toLocaleDateString('en-IN', { month: 'long', year: 'numeric' }); if(!grouped[key]) grouped[key] = { total: 0, items: [] }; grouped[key].items.push(p); grouped[key].total += p.amount; }); Object.keys(grouped).forEach(month => { tbody.innerHTML += `<tr class="bg-indigo-50 border-b border-indigo-100"><td colspan="3" class="p-3 text-xs font-bold text-indigo-800 uppercase tracking-wider">${month}</td><td class="p-3 text-right text-xs font-bold text-indigo-800">Total: ₹${grouped[month].total.toLocaleString()}</td></tr>`; grouped[month].items.forEach(p => { const c = store.data.customers.find(x => x.id === p.customerId); tbody.innerHTML += `<tr class="hover:bg-slate-50 border-b row-hover"><td class="p-4 text-slate-500 text-xs pl-8">${p.date}</td><td class="p-4 font-medium">${c?c.name:'Unknown'}</td><td class="p-4"><div class="text-sm">${p.note || ''}</div>${p.collectedBy ? `<div class="text-xs text-brand-600"><i class="fas fa-user-tag mr-1"></i>${p.collectedBy}</div>` : ''}</td><td class="p-4 text-right font-bold text-green-600">₹${p.amount}</td></tr>`; }); }); const now = new Date(); const currentMonthKey = now.toLocaleDateString('en-IN', { month: 'long', year: 'numeric' }); document.getElementById('billingMonthTotal').innerText = '₹' + (grouped[currentMonthKey] ? grouped[currentMonthKey].total.toLocaleString() : 0); document.getElementById('billingMonthName').innerText = currentMonthKey; },
            async recordPayment(e) { e.preventDefault(); const body = { customerId: document.getElementById('payCustomer').value, amount: parseFloat(document.getElementById('payAmount').value), date: document.getElementById('payDate').value, collectedBy: document.getElementById('payCollector').value, note: document.getElementById('payNote').value }; if(await api.post('/api/payments', body)) { showToast('Payment Recorded'); document.getElementById('payAmount').value = ''; document.getElementById('payNote').value = ''; await store.sync(); this.init(); app.renderDashboard(); } },
            generateInvoice() { const cid = document.getElementById('invoiceCustomer').value; if(!cid) return showToast('Select a customer', 'error'); const c = store.data.customers.find(x => x.id === cid); const orders = store.data.orders.filter(o => o.customerId === cid).sort((a,b) => new Date(b.date) - new Date(a.date)); const payments = store.data.payments.filter(p => p.customerId === cid).sort((a,b) => new Date(b.date) - new Date(a.date)); document.getElementById('billing').classList.add('hidden'); document.getElementById('invoice-view').classList.remove('hidden'); document.getElementById('inv-cust-name').innerText = c.name; document.getElementById('inv-date').innerText = `Date: ${new Date().toLocaleDateString()}`; const outstanding = c.dues; let html = `<div class="mb-6 text-right font-bold text-xl ${outstanding>0?'text-red-600 bg-red-50 border-red-100':'text-green-600 bg-green-50 border-green-100'} border p-4 inline-block float-right rounded-xl shadow-sm">Current Dues: ₹${outstanding}</div><h3 class="font-bold border-b pb-2 mb-4 text-lg">Recent Transactions</h3><table class="w-full text-sm text-left mb-8"><thead class="bg-slate-100 rounded-lg"><tr><th class="p-3 rounded-l-lg">Date</th><th class="p-3">Type</th><th class="p-3">Details</th><th class="p-3 text-right rounded-r-lg">Amount</th></tr></thead><tbody>`; const allTx = [...orders.map(o => ({ date: o.date, type: 'Order', desc: o.items.map(i=>`${i.quantity} ${i.name}`).join(', '), amt: o.total })), ...payments.map(p => ({ date: p.date, type: 'Payment', desc: 'Cash/Online', amt: -p.amount }))].sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0, 15); allTx.forEach(t => html += `<tr class="border-b"><td class="p-3">${t.date}</td><td class="p-3 font-bold ${t.type==='Payment'?'text-green-600':'text-slate-600'}">${t.type}</td><td class="p-3 text-slate-500">${t.desc}</td><td class="p-3 text-right font-bold">${t.amt > 0 ? '₹'+t.amt : '-₹'+Math.abs(t.amt)}</td></tr>`); document.getElementById('invoice-content').innerHTML = html + `</tbody></table>`; const msg = `Hello ${c.name},%0A%0AHere is your account statement from Dairy Manager Pro.%0A*Current Outstanding Balance: ₹${outstanding}*%0A%0APlease clear your dues at the earliest.%0A%0AThank you!`; document.getElementById('invoice-view').dataset.phone = c.phone; },
            shareInvoicePDF() { const element = document.getElementById('invoice-view'); const phone = element.dataset.phone; const opt = { margin: 10, filename: `Invoice_${new Date().toISOString().split('T')[0]}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } }; showToast("Generating PDF..."); html2pdf().set(opt).from(element).save().then(() => { showToast("PDF Downloaded. Please attach in WhatsApp."); setTimeout(() => { window.open(`https://wa.me/91${phone}`, '_blank'); }, 1500); }); }
        };

        const expenseManager = { render() { const s = document.getElementById('expCategory'); s.innerHTML = ''; store.data.expenseCategories.forEach(c => s.innerHTML += `<option value="${c}">${c}</option>`); const emp = document.getElementById('expEmployee'); emp.innerHTML = '<option value="">-- Other / Vendor --</option>'; const filter = document.getElementById('expLogFilter'); if(filter) { const currentVal = filter.value; filter.innerHTML = '<option value="">All Staff/Vendors</option>'; store.data.employees.forEach(e => { const opt = `<option value="${e.name}">${e.name} (${e.role})</option>`; emp.innerHTML += opt; filter.innerHTML += `<option value="${e.name}">${e.name}</option>`; }); filter.value = currentVal; } else { store.data.employees.forEach(e => emp.innerHTML += `<option value="${e.name}">${e.name} (${e.role})</option>`); } this.renderLog(); }, async renderLog() { const tbody = document.getElementById('expenseTableBody'); tbody.innerHTML = ''; const empFilter = document.getElementById('expLogFilter')?.value || ''; let exps = store.data.expenses; if(empFilter) exps = exps.filter(e => e.employeeId === empFilter); exps.sort((a,b) => new Date(b.date) - new Date(a.date)); const grouped = {}; exps.forEach(e => { const d = new Date(e.date); const key = d.toLocaleDateString('en-IN', { month: 'long', year: 'numeric' }); if(!grouped[key]) grouped[key] = { total: 0, items: [] }; grouped[key].items.push(e); grouped[key].total += e.amount; }); Object.keys(grouped).forEach(month => { tbody.innerHTML += `<tr class="bg-gray-50 border-b border-gray-100"><td colspan="2" class="p-3 text-xs font-bold text-gray-500 uppercase tracking-wider pl-4">${month}</td><td class="p-3 text-right text-xs font-bold text-gray-600">Total: ₹${grouped[month].total.toLocaleString()}</td></tr>`; grouped[month].items.forEach(e => { tbody.innerHTML += `<tr class="border-b border-slate-50 hover:bg-slate-50 row-hover"><td class="p-4 text-slate-500 pl-8">${e.date}</td><td class="p-4 font-medium"><div class="text-slate-800">${e.title}</div><div class="mt-1"><span class="text-xs bg-slate-100 px-2 py-1 rounded text-slate-500 border">${e.category}</span> ${e.employeeId ? `<span class="ml-2 text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded"><i class="fas fa-user mr-1"></i>${e.employeeId}</span>` : ''}</div></td><td class="p-4 text-right font-bold text-red-500">₹${e.amount}</td></tr>`; }); }); }, async add(e) { e.preventDefault(); const body = { title: document.getElementById('expTitle').value, amount: parseFloat(document.getElementById('expAmount').value), category: document.getElementById('expCategory').value, date: document.getElementById('expDate').value, employeeId: document.getElementById('expEmployee').value }; if(await api.post('/api/expenses', body)) { showToast('Expense Added'); await store.sync(); this.render(); } } };
        const settingsManager = { render() { const c = document.getElementById('productSettingsList'); c.innerHTML = ''; store.data.products.forEach(p => { if (p.isActive !== false) { c.innerHTML += `<div class="bg-slate-50 p-4 rounded-xl border border-slate-200 relative group"><button onclick="settingsManager.delProduct('${p.id}')" class="absolute top-3 right-3 text-slate-400 hover:text-red-500 transition opacity-0 group-hover:opacity-100"><i class="fas fa-trash"></i></button><div class="font-bold text-slate-700 mb-2">${p.name}</div><div class="flex items-center gap-2"><span class=\"text-sm font-bold text-slate-500\">₹</span><input type=\"number\" class=\"w-full border rounded-lg p-1.5 text-sm bg-white focus:outline-none focus:border-brand-500\" value=\"${p.price}\" onchange=\"settingsManager.updatePrice('${p.id}', this.value)\"></div></div>`}}); const e = document.getElementById('employeeList'); e.innerHTML = ''; store.data.employees.forEach(emp => e.innerHTML += `<div class="flex justify-between items-center bg-slate-50 p-4 rounded-xl border border-slate-200 group"><div><div class="font-bold text-sm text-slate-800">${emp.name}</div><div class="text-xs text-slate-500">${emp.role} • ${emp.phone || 'No Phone'}</div></div><button onclick="settingsManager.delEmployee('${emp.id}')" class="text-slate-400 hover:text-red-500 transition opacity-0 group-hover:opacity-100"><i class="fas fa-trash"></i></button></div>`); }, async addProduct() { const name = prompt("Name:"); const price = prompt("Price:"); if(name && price) { await api.post('/api/products', {name, price: parseFloat(price)}); await store.sync(); this.render(); } }, async delProduct(id) { ui.showConfirm('Delete Product?', 'Are you sure? This will remove the product from future sheets, but keep history.', async () => { await api.del(`/api/products/${id}`); await store.sync(); this.render(); }); }, async updatePrice(id, val) { await api.put(`/api/products/${id}`, {price: parseFloat(val)}); await store.sync(); }, openEmployeeModal() { document.getElementById('employeeModal').classList.remove('hidden'); document.getElementById('empName').value = ''; document.getElementById('empPhone').value = ''; document.getElementById('empRole').value = ''; }, closeEmployeeModal() { document.getElementById('employeeModal').classList.add('hidden'); }, async saveEmployee() { const body = { name: document.getElementById('empName').value, phone: document.getElementById('empPhone').value, role: document.getElementById('empRole').value }; if(await api.post('/api/employees', body)) { this.closeEmployeeModal(); await store.sync(); this.render(); } }, async delEmployee(id) { ui.showConfirm('Remove Staff?', 'Are you sure you want to remove this employee?', async () => { await api.del(`/api/employees/${id}`); await store.sync(); this.render(); }); } };
        
        // Window Load: Check for Token
        window.onload = () => {
            auth.check();
            document.getElementById('username').focus();
        };
    </script>
</body>

</html>



