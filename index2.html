<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dairy Manager Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Mobile Sidebar Transition */
        .sidebar-transition { transition: transform 0.3s ease-in-out; }
        
        /* Print Styles */
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; height: auto; overflow: visible; }
            #sidebar, #loginScreen, #mobileHeader, #toast-container { display: none; }
            #mainContent { margin: 0; padding: 0; overflow: visible; width: 100%; }
        }
        .print-only { display: none; }
    </style>
</head>
<body class="bg-slate-100 h-screen flex flex-col md:flex-row text-slate-800 overflow-hidden">

    <!-- TOAST CONTAINER -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-[100] flex flex-col gap-2 pointer-events-none"></div>

    <!-- LOGIN SCREEN -->
    <div id="loginScreen" class="fixed inset-0 bg-slate-900 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8 text-center fade-in">
            <div class="mb-6">
                <div class="h-16 w-16 bg-blue-600 rounded-full flex items-center justify-center text-white text-3xl mx-auto mb-4">
                    <i class="fas fa-cow"></i>
                </div>
                <h1 class="text-2xl font-bold text-slate-800">Dairy Manager</h1>
                <p class="text-slate-500">Distribution & Billing System</p>
            </div>
            <form onsubmit="auth.login(event)" class="space-y-4 text-left">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Username</label>
                    <input type="text" id="username" class="w-full border border-slate-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="admin" value="admin">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Password</label>
                    <input type="password" id="password" class="w-full border border-slate-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="••••••" value="password">
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition shadow-lg shadow-blue-200">
                    Sign In
                </button>
            </form>
            <p class="mt-4 text-xs text-slate-400">Demo Credentials: admin / password</p>
        </div>
    </div>

    <!-- MOBILE HEADER -->
    <div id="mobileHeader" class="md:hidden bg-slate-900 text-white p-4 flex justify-between items-center z-30 shadow-md">
        <div class="flex items-center gap-2">
            <i class="fas fa-cow text-blue-400 text-xl"></i>
            <span class="font-bold text-lg">DairyMgr</span>
        </div>
        <button onclick="app.toggleSidebar()" class="text-white focus:outline-none">
            <i class="fas fa-bars text-xl"></i>
        </button>
    </div>

    <!-- SIDEBAR -->
    <aside class="fixed md:relative inset-y-0 left-0 w-64 bg-slate-900 text-white flex-shrink-0 flex flex-col z-40 sidebar-transition -translate-x-full md:translate-x-0 shadow-xl md:shadow-none" id="sidebar">
        <div class="p-5 border-b border-slate-800 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="fas fa-cow text-blue-400 text-xl"></i>
                <span class="font-bold text-lg tracking-wide">DairyMgr</span>
            </div>
            <!-- Mobile Close Button -->
            <button onclick="app.toggleSidebar()" class="md:hidden text-slate-400 hover:text-white">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <nav class="flex-1 overflow-y-auto p-4 space-y-1">
            <p class="px-4 text-xs font-bold text-slate-500 uppercase mb-2 mt-2">Operations</p>
            <button onclick="router.navigate('dashboard')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-slate-800 text-slate-400 transition" data-target="dashboard">
                <i class="fas fa-home w-5"></i> <span>Dashboard</span>
            </button>
            <button onclick="router.navigate('orders')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-slate-800 text-slate-400 transition" data-target="orders">
                <i class="fas fa-truck w-5"></i> <span>Orders & Route</span>
            </button>
            <button onclick="router.navigate('customers')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-slate-800 text-slate-400 transition" data-target="customers">
                <i class="fas fa-users w-5"></i> <span>Customers</span>
            </button>
            
            <p class="px-4 text-xs font-bold text-slate-500 uppercase mb-2 mt-6">Finance</p>
            <button onclick="router.navigate('billing')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-slate-800 text-slate-400 transition" data-target="billing">
                <i class="fas fa-file-invoice-dollar w-5"></i> <span>Invoices & Payments</span>
            </button>
            <button onclick="router.navigate('expenses')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-slate-800 text-slate-400 transition" data-target="expenses">
                <i class="fas fa-wallet w-5"></i> <span>Expenses</span>
            </button>
            <button onclick="router.navigate('reports')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-slate-800 text-slate-400 transition" data-target="reports">
                <i class="fas fa-chart-bar w-5"></i> <span>Reports</span>
            </button>

            <p class="px-4 text-xs font-bold text-slate-500 uppercase mb-2 mt-6">System</p>
            <button onclick="router.navigate('settings')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-slate-800 text-slate-400 transition" data-target="settings">
                <i class="fas fa-cog w-5"></i> <span>Settings</span>
            </button>
        </nav>

        <div class="p-4 border-t border-slate-800">
            <button onclick="auth.logout()" class="flex items-center space-x-3 px-4 py-2 text-red-400 hover:text-red-300 w-full transition text-sm">
                <i class="fas fa-sign-out-alt"></i> <span>Logout</span>
            </button>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 overflow-y-auto relative bg-slate-50 p-4 md:p-8 w-full" id="mainContent">
        <!-- Overlay for mobile sidebar -->
        <div id="sidebarOverlay" onclick="app.toggleSidebar()" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>
        
        <!-- DASHBOARD -->
        <section id="dashboard" class="view-section fade-in">
            <div class="flex justify-between items-end mb-6">
                <div>
                    <h2 class="text-3xl font-bold text-slate-800">Dashboard</h2>
                    <p class="text-sm text-slate-500">Business Overview</p>
                </div>
                <span class="text-sm bg-blue-100 text-blue-700 px-3 py-1 rounded-full font-medium" id="currentDateDisplay"></span>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- Box 1: Sales (Green Theme) -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border-t-4 border-green-500">
                    <div class="flex justify-between items-start">
                        <p class="text-slate-500 text-sm font-medium">Today's Sales</p>
                        <span id="revenue-badge" class="text-xs font-bold text-gray-500 bg-gray-100 px-2 py-1 rounded">0%</span>
                    </div>
                    <h3 class="text-3xl font-bold text-green-600 mt-2" id="dash-revenue-today">₹0</h3>
                </div>
                <!-- Box 2: Opening Dues (Neutral) -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border-t-4 border-slate-400">
                    <p class="text-slate-500 text-sm font-medium">Opening Dues</p>
                    <h3 class="text-3xl font-bold text-slate-700 mt-2" id="dash-dues-prev">₹0</h3>
                </div>
                <!-- Box 3: Net Outstanding (Red Theme) -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border-t-4 border-red-500">
                    <p class="text-slate-500 text-sm font-medium">Net Outstanding</p>
                    <h3 class="text-3xl font-bold text-red-500 mt-2" id="dash-dues-total">₹0</h3>
                </div>
                <!-- Box 4: Active Customers -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border-t-4 border-blue-500">
                    <p class="text-slate-500 text-sm font-medium">Active Customers</p>
                    <h3 class="text-3xl font-bold text-slate-800 mt-2" id="dash-cust">0</h3>
                </div>
            </div>

            <!-- Chart & Alerts Section -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                <!-- Sales Chart -->
                <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <h3 class="font-bold text-slate-700 mb-4">Sales Trend (Last 7 Days)</h3>
                    <div class="relative h-64 w-full">
                        <canvas id="salesChart"></canvas>
                    </div>
                </div>
                
                <!-- High Dues Alert -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-red-100 flex flex-col">
                    <h3 class="font-bold text-red-700 mb-4 flex items-center justify-between">
                        <span><i class="fas fa-exclamation-circle mr-2"></i> Top Defaulters</span>
                        <span class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded border border-red-200">Critical</span>
                    </h3>
                    <div class="flex-1 overflow-y-auto" id="highDuesList">
                        <!-- Populated via JS -->
                    </div>
                </div>
            </div>
        </section>

        <!-- CUSTOMERS -->
        <section id="customers" class="view-section hidden fade-in">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-slate-800">Customers</h2>
                <button onclick="customerManager.openModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-lg font-medium shadow-lg shadow-blue-200 transition"><i class="fas fa-plus mr-2"></i> Add Customer</button>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="p-4 border-b border-slate-100 bg-slate-50 flex flex-col md:flex-row gap-4 justify-between">
                    <div class="relative flex-1">
                        <i class="fas fa-search absolute left-3 top-3 text-slate-400"></i>
                        <input type="text" id="customerSearch" placeholder="Search customers..." class="w-full pl-10 pr-4 py-2 border border-slate-200 rounded-lg focus:outline-none focus:border-blue-500" onkeyup="customerManager.renderList()">
                    </div>
                    <select id="customerSort" class="border border-slate-200 rounded-lg p-2 text-sm focus:outline-none focus:border-blue-500" onchange="customerManager.renderList()">
                        <option value="name">Sort by Name</option>
                        <option value="dues_high">Sort by Dues (High-Low)</option>
                        <option value="dues_low">Sort by Dues (Low-High)</option>
                    </select>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 text-slate-500 text-xs uppercase font-semibold">
                            <tr>
                                <th class="p-4">Customer Info</th>
                                <th class="p-4">Contact</th>
                                <th class="p-4 text-right">Outstanding</th>
                                <th class="p-4 text-center">Status</th>
                                <th class="p-4 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="customerTableBody" class="divide-y divide-slate-100 text-sm"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- ORDERS -->
        <section id="orders" class="view-section hidden fade-in">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4 no-print">
                <div>
                    <h2 class="text-2xl font-bold text-slate-800">Daily Route</h2>
                    <p class="text-slate-500 text-sm">Manage deliveries and print route sheets.</p>
                </div>
                <div class="flex flex-wrap gap-2">
                    <div class="bg-white rounded-lg border border-slate-300 p-1 flex">
                        <button onclick="orderManager.setMode('plan')" id="mode-plan" class="px-4 py-1.5 rounded-md text-sm font-medium transition">Plan</button>
                        <button onclick="orderManager.setMode('distribute')" id="mode-dist" class="px-4 py-1.5 rounded-md text-sm font-medium transition bg-blue-600 text-white">Route</button>
                    </div>
                    <button onclick="orderManager.fillYesterday()" class="bg-blue-100 text-blue-700 border border-blue-200 px-4 py-2 rounded-lg hover:bg-blue-200 transition font-medium" title="Copy quantities from last order"><i class="fas fa-history mr-1"></i> Copy Prev</button>
                    <button onclick="window.print()" class="bg-slate-800 text-white px-4 py-2 rounded-lg hover:bg-slate-700 transition"><i class="fas fa-print mr-2"></i> Print</button>
                </div>
            </div>

            <div class="print-only mb-6 text-center border-b pb-4">
                <h1 class="text-2xl font-bold">Daily Distribution Sheet</h1>
                <p class="text-sm text-gray-600">Date: <span id="printDate"></span></p>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 text-slate-600 text-xs uppercase font-bold border-b border-slate-200">
                            <tr id="routeHeaderRow">
                                <th class="p-4 w-1/3">Customer</th>
                                <!-- Dynamic Headers -->
                            </tr>
                        </thead>
                        <tbody id="orderTableBody" class="divide-y divide-slate-100 text-sm"></tbody>
                        <tfoot id="orderTableFooter" class="bg-slate-100 font-bold text-slate-700 text-sm border-t-2 border-slate-200">
                            <!-- Dynamic Footer with Totals -->
                        </tfoot>
                    </table>
                </div>
                <div class="p-4 border-t border-slate-100 bg-slate-50 flex justify-between items-center no-print">
                    <div class="text-sm text-slate-500">Orders: <span id="totalOrdersCount" class="font-bold text-slate-800">0</span></div>
                    <button onclick="orderManager.saveAll()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium shadow-lg shadow-green-200 transition">Save & Close Day</button>
                </div>
            </div>
            
            <div class="print-only mt-8 flex justify-between text-sm text-gray-500 pt-8 border-t border-gray-300">
                <div>Distributor Signature</div>
                <div>Supervisor Signature</div>
            </div>
        </section>

        <!-- BILLING -->
        <section id="billing" class="view-section hidden fade-in">
            <h2 class="text-2xl font-bold text-slate-800 mb-6">Billing & Payments</h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Record Payment & Invoice -->
                <div class="lg:col-span-1 space-y-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                        <h3 class="font-bold text-lg mb-4 text-slate-800 flex items-center"><i class="fas fa-hand-holding-usd text-green-500 mr-2"></i> Record Payment</h3>
                        <form onsubmit="billingManager.recordPayment(event)">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Customer</label>
                                    <select id="payCustomer" class="w-full border-slate-300 rounded-lg p-2.5 bg-slate-50 focus:ring-2 focus:ring-green-500 outline-none border" required></select>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Amount (₹)</label>
                                    <input type="number" id="payAmount" min="0" class="w-full border-slate-300 rounded-lg p-2.5 bg-slate-50 focus:ring-2 focus:ring-green-500 outline-none border" required>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Date</label>
                                    <input type="date" id="payDate" class="w-full border-slate-300 rounded-lg p-2.5 bg-slate-50 focus:ring-2 focus:ring-green-500 outline-none border" required>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Collected By</label>
                                    <select id="payCollector" class="w-full border-slate-300 rounded-lg p-2.5 bg-slate-50 focus:ring-2 focus:ring-green-500 outline-none border"></select>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Note (Optional)</label>
                                    <input type="text" id="payNote" placeholder="e.g. Cash, UPI Ref..." class="w-full border-slate-300 rounded-lg p-2.5 bg-slate-50 focus:ring-2 focus:ring-green-500 outline-none border">
                                </div>
                                <button type="submit" class="w-full bg-slate-900 hover:bg-slate-800 text-white font-bold py-3 rounded-lg transition">Save Payment</button>
                            </div>
                        </form>
                    </div>

                    <div class="bg-blue-50 p-6 rounded-2xl border border-blue-100">
                        <h3 class="font-bold text-blue-800 mb-2">Invoice Generator</h3>
                        <div class="space-y-3">
                            <select id="invoiceCustomer" class="w-full border-blue-200 rounded-lg p-2 text-sm bg-white"></select>
                            <button onclick="billingManager.generateInvoice()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 rounded-lg transition">Generate Statement</button>
                        </div>
                    </div>
                </div>

                <!-- Dues & History -->
                <div class="lg:col-span-2 space-y-6">
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden flex flex-col h-[600px]">
                        <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                            <h3 class="font-bold text-slate-700">Payment History</h3>
                        </div>
                        <div class="overflow-y-auto flex-1">
                            <table class="w-full text-left">
                                <thead class="bg-white text-slate-500 text-xs uppercase sticky top-0 shadow-sm">
                                    <tr>
                                        <th class="p-4 bg-slate-50">Date</th>
                                        <th class="p-4 bg-slate-50">Customer</th>
                                        <th class="p-4 bg-slate-50">Details</th>
                                        <th class="p-4 bg-slate-50 text-right">Amount</th>
                                    </tr>
                                </thead>
                                <tbody id="paymentHistoryBody" class="divide-y divide-slate-50 text-sm"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- INVOICE VIEW (Hidden until generated) -->
        <section id="invoice-view" class="view-section hidden bg-white p-8 max-w-4xl mx-auto shadow-lg my-8 print:shadow-none print:w-full print:m-0">
            <div class="flex justify-between items-start mb-8 border-b pb-4">
                <div>
                    <h1 class="text-3xl font-bold text-slate-800">INVOICE</h1>
                    <p class="text-slate-500">Dairy Manager Pro</p>
                </div>
                <div class="text-right">
                    <h2 class="text-xl font-bold" id="inv-cust-name">Customer Name</h2>
                    <p class="text-sm text-slate-500" id="inv-date">Date: 2023-01-01</p>
                </div>
            </div>
            <div id="invoice-content" class="mb-8">
                <!-- Populated by JS -->
            </div>
            <div class="flex justify-end gap-4 no-print">
                <button onclick="router.navigate('billing')" class="px-4 py-2 border rounded hover:bg-slate-50">Back</button>
                <button id="whatsappShareBtn" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 flex items-center"><i class="fab fa-whatsapp mr-2"></i> Share</button>
                <button onclick="window.print()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Print Invoice</button>
            </div>
        </section>

        <!-- EXPENSES -->
        <section id="expenses" class="view-section hidden fade-in">
            <h2 class="text-2xl font-bold text-slate-800 mb-6">Expense Manager</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 h-fit">
                    <h3 class="font-bold text-lg mb-4 text-slate-800">Add New Expense</h3>
                    <form onsubmit="expenseManager.add(event)" class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Description / Details</label>
                            <input type="text" id="expTitle" placeholder="e.g., Diesel for Truck, Office Rent" class="w-full border-slate-300 rounded-lg p-2.5 border" required>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Category</label>
                                <select id="expCategory" class="w-full border-slate-300 rounded-lg p-2.5 border"></select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Paid To (Employee?)</label>
                                <select id="expEmployee" class="w-full border-slate-300 rounded-lg p-2.5 border">
                                    <option value="">-- Other / Vendor --</option>
                                    <!-- Employees Populated Here -->
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Amount (₹)</label>
                            <input type="number" id="expAmount" min="0" class="w-full border-slate-300 rounded-lg p-2.5 border" required>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Date</label>
                            <input type="date" id="expDate" class="w-full border-slate-300 rounded-lg p-2.5 border" required>
                        </div>
                        <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg transition">Add Expense</button>
                    </form>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden flex flex-col h-[500px]">
                    <div class="p-5 border-b border-slate-100 bg-slate-50 font-bold text-slate-700">Expense Log</div>
                    <div class="overflow-y-auto flex-1">
                        <table class="w-full text-left">
                            <thead class="bg-white text-slate-500 text-xs uppercase sticky top-0 shadow-sm">
                                <tr>
                                    <th class="p-4 bg-slate-50">Date</th>
                                    <th class="p-4 bg-slate-50">Description</th>
                                    <th class="p-4 bg-slate-50 text-right">Amount</th>
                                </tr>
                            </thead>
                            <tbody id="expenseTableBody" class="divide-y divide-slate-50 text-sm"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- REPORTS -->
        <section id="reports" class="view-section hidden fade-in">
            <h2 class="text-2xl font-bold text-slate-800 mb-6">Reports & Analytics</h2>
            
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 mb-6">
                <div class="flex flex-wrap gap-4 items-end">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">Report Type</label>
                        <select id="reportType" class="border p-2 rounded-lg text-sm w-48" onchange="reportManager.toggleInputs()">
                            <option value="financial">Financial Summary</option>
                            <option value="customer_monthly">Customer Statement</option>
                            <option value="day_book">Day Book (Orders)</option>
                        </select>
                    </div>
                    <div id="dateRangeInputs" class="flex gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">Start Date</label>
                            <input type="date" id="repStartDate" class="border p-2 rounded-lg text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">End Date</label>
                            <input type="date" id="repEndDate" class="border p-2 rounded-lg text-sm">
                        </div>
                    </div>
                    <div id="custInput" class="hidden">
                        <label class="block text-xs font-bold text-slate-500 mb-1">Customer</label>
                        <select id="repCustomer" class="border p-2 rounded-lg text-sm w-48"></select>
                    </div>
                    <button onclick="reportManager.generate()" class="bg-blue-600 text-white px-6 py-2 rounded-lg text-sm font-bold hover:bg-blue-700 h-[38px]">Generate Report</button>
                </div>
            </div>

            <div id="reportOutput" class="bg-white rounded-2xl shadow-sm border border-slate-200 p-8 min-h-[300px] print-only">
                <div class="text-center text-slate-400 mt-10">Select parameters above to generate report.</div>
            </div>
        </section>

        <!-- SETTINGS -->
        <section id="settings" class="view-section hidden fade-in">
            <h2 class="text-2xl font-bold text-slate-800 mb-6">System Settings</h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Products -->
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden mb-6">
                    <div class="p-5 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                        <span class="font-bold text-slate-700">Product Management</span>
                        <button onclick="settingsManager.addProduct()" class="text-sm text-blue-600 hover:underline"><i class="fas fa-plus"></i> Add Product</button>
                    </div>
                    <div class="p-6">
                        <div class="grid grid-cols-1 gap-4" id="productSettingsList"></div>
                    </div>
                </div>

                <!-- Employee Management (NEW) -->
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden mb-6">
                    <div class="p-5 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                        <span class="font-bold text-slate-700">Employee List</span>
                        <button onclick="settingsManager.addEmployee()" class="text-sm text-blue-600 hover:underline"><i class="fas fa-plus"></i> Add Staff</button>
                    </div>
                    <div class="p-6">
                        <div class="space-y-2" id="employeeList"></div>
                    </div>
                </div>
            </div>

            <!-- Data Management -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden mb-6">
                <div class="p-5 border-b border-slate-100 bg-slate-50 font-bold text-slate-700">Data Management</div>
                <div class="p-6 flex flex-col md:flex-row gap-4">
                    <button onclick="dataManager.backup()" class="flex items-center justify-center gap-2 px-6 py-3 bg-slate-800 text-white rounded-lg hover:bg-slate-700 transition">
                        <i class="fas fa-download"></i> Backup Data
                    </button>
                    <button onclick="document.getElementById('restoreFile').click()" class="flex items-center justify-center gap-2 px-6 py-3 bg-white border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 transition">
                        <i class="fas fa-upload"></i> Restore Data
                    </button>
                    <input type="file" id="restoreFile" class="hidden" accept=".json" onchange="dataManager.restore(this)">
                </div>
            </div>
        </section>

    </main>

    <!-- MODALS -->
    <!-- Add/Edit Customer -->
    <div id="customerModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden transform transition-all">
            <div class="p-5 border-b bg-slate-50 flex justify-between items-center">
                <h3 class="font-bold text-lg text-slate-800" id="modalTitle">Add Customer</h3>
                <button onclick="customerManager.closeModal()" class="text-slate-400 hover:text-red-500"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="custId">
                <div>
                    <label class="block text-xs uppercase font-bold text-slate-500 mb-1">Customer Name</label>
                    <input type="text" id="custName" class="w-full border border-slate-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-xs uppercase font-bold text-slate-500 mb-1">Phone Number</label>
                    <input type="tel" id="custPhone" class="w-full border border-slate-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" oninput="customerManager.checkDuplicate(this.value)">
                    <p id="dupWarning" class="text-xs text-orange-600 mt-2 hidden font-medium flex items-center"><i class="fas fa-exclamation-triangle mr-1"></i> Warning: Phone exists!</p>
                </div>
                <div>
                    <label class="block text-xs uppercase font-bold text-slate-500 mb-1">Address</label>
                    <textarea id="custAddress" class="w-full border border-slate-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" rows="3"></textarea>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button onclick="customerManager.closeModal()" class="px-5 py-2.5 text-slate-600 hover:bg-slate-100 rounded-lg font-medium">Cancel</button>
                    <button onclick="customerManager.save()" class="px-5 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Rate Management Modal -->
    <div id="rateModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden">
            <div class="p-5 border-b bg-slate-50 flex justify-between items-center">
                <h3 class="font-bold text-lg text-slate-800">Manage Rates</h3>
                <button onclick="document.getElementById('rateModal').classList.add('hidden')" class="text-slate-400 hover:text-red-500"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6">
                <p class="text-sm text-slate-500 mb-4">Set custom rates for <span id="rateCustName" class="font-bold text-slate-800"></span>. Leave empty to use standard price.</p>
                <input type="hidden" id="rateCustId">
                <div id="rateInputs" class="space-y-3"></div>
                <div class="mt-6 flex justify-end">
                    <button onclick="customerManager.saveRates()" class="px-5 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium w-full">Save Rates</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- TOAST NOTIFICATION SYSTEM ---
        const showToast = (msg, type='success') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const color = type === 'error' ? 'bg-red-500' : 'bg-slate-800';
            const icon = type === 'error' ? 'fa-exclamation-circle' : 'fa-check-circle';
            
            toast.className = `${color} text-white px-6 py-4 rounded-lg shadow-xl transform transition-all duration-300 translate-y-10 opacity-0 flex items-center min-w-[300px] pointer-events-auto`;
            toast.innerHTML = `<i class="fas ${icon} mr-3 text-lg"></i> <span class="font-medium">${msg}</span>`;
            
            container.appendChild(toast);
            requestAnimationFrame(() => toast.classList.remove('translate-y-10', 'opacity-0'));
            setTimeout(() => {
                toast.classList.add('translate-y-10', 'opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        };

        // --- DATA STORE ---
        const store = {
            data: {
                customers: JSON.parse(localStorage.getItem('dairy_customers')) || [
                    { id: 'C1001', name: 'Sharma Household', phone: '9876543210', address: 'Plot 45, Colony A', dues: 450, status: 'Active', customRates: {} },
                ],
                products: JSON.parse(localStorage.getItem('dairy_products')) || [
                    { id: 'p1', name: 'Full Cream', price: 64, unit: 'L' },
                    { id: 'p2', name: 'Toned Milk', price: 54, unit: 'L' }
                ],
                expenseCategories: JSON.parse(localStorage.getItem('dairy_categories')) || ['Operational', 'Purchase', 'Maintenance', 'Salary', 'Advance'],
                employees: JSON.parse(localStorage.getItem('dairy_employees')) || ['Driver Raju', 'Helper Shyam', 'Manager'],
                orders: JSON.parse(localStorage.getItem('dairy_orders')) || [],
                payments: JSON.parse(localStorage.getItem('dairy_payments')) || [],
                expenses: JSON.parse(localStorage.getItem('dairy_expenses')) || []
            },
            save(key) {
                localStorage.setItem(`dairy_${key}`, JSON.stringify(this.data[key]));
            }
        };

        // --- CHART CONTROLLER ---
        let salesChartInstance = null;
        const chartManager = {
            render() {
                const ctx = document.getElementById('salesChart');
                if(!ctx) return;
                
                const labels = [];
                const dataPoints = [];
                for(let i=6; i>=0; i--) {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    const dateStr = d.toISOString().split('T')[0];
                    labels.push(d.toLocaleDateString('en-IN', {weekday:'short'}));
                    
                    const dailyTotal = store.data.orders
                        .filter(o => o.date === dateStr)
                        .reduce((sum, o) => sum + o.total, 0);
                    dataPoints.push(dailyTotal);
                }

                if(salesChartInstance) salesChartInstance.destroy();
                
                salesChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Sales (₹)',
                            data: dataPoints,
                            backgroundColor: '#22c55e', // Green
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true, grid: { display:false } }, x: { grid: { display: false } } }
                    }
                });
            }
        };

        // --- AUTH & APP ---
        const auth = {
            login(e) {
                e.preventDefault();
                document.getElementById('loginScreen').classList.add('hidden');
                app.init();
            },
            logout() { location.reload(); }
        };

        const app = {
            init() {
                this.renderDashboard();
                router.navigate('dashboard');
                document.getElementById('currentDateDisplay').innerText = new Date().toLocaleDateString('en-IN', { weekday: 'short', day: 'numeric', month: 'short' });
                const today = new Date().toISOString().split('T')[0];
                document.querySelectorAll('input[type="date"]').forEach(el => {
                    if(!el.value) el.value = today;
                });
            },
            toggleSidebar() {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebarOverlay');
                sidebar.classList.toggle('-translate-x-full');
                overlay.classList.toggle('hidden');
            },
            renderDashboard() {
                const today = new Date().toISOString().split('T')[0];
                const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
                
                const todaysRevenue = store.data.orders.filter(o => o.date === today).reduce((s, o) => s + o.total, 0);
                const yesterdaysRevenue = store.data.orders.filter(o => o.date === yesterday).reduce((s, o) => s + o.total, 0);
                
                let pctChange = 0;
                if(yesterdaysRevenue > 0) pctChange = Math.round(((todaysRevenue - yesterdaysRevenue) / yesterdaysRevenue) * 100);
                else if (todaysRevenue > 0) pctChange = 100;

                const totalOutstanding = store.data.customers.reduce((sum, c) => sum + (c.dues || 0), 0);
                const openingDues = totalOutstanding - todaysRevenue; 

                document.getElementById('dash-revenue-today').innerText = '₹' + todaysRevenue.toLocaleString();
                const badge = document.getElementById('revenue-badge');
                badge.innerText = (pctChange >= 0 ? '+' : '') + pctChange + '%';
                badge.className = pctChange >= 0 ? 'text-xs font-bold text-green-500 bg-green-50 px-2 py-1 rounded' : 'text-xs font-bold text-red-500 bg-red-50 px-2 py-1 rounded';

                document.getElementById('dash-dues-prev').innerText = '₹' + openingDues.toLocaleString();
                document.getElementById('dash-dues-total').innerText = '₹' + totalOutstanding.toLocaleString();
                document.getElementById('dash-cust').innerText = store.data.customers.length;

                chartManager.render();

                const highDuesList = document.getElementById('highDuesList');
                highDuesList.innerHTML = '';
                const defaulters = store.data.customers.filter(c => c.dues > 1000).sort((a,b) => b.dues - a.dues).slice(0, 5);
                
                if(defaulters.length === 0) {
                    highDuesList.innerHTML = '<div class="text-sm text-green-600 text-center py-4 bg-green-50 rounded">Everything looks good!</div>';
                } else {
                    defaulters.forEach(c => {
                        highDuesList.innerHTML += `
                            <div class="flex justify-between items-center py-2 border-b border-red-50 last:border-0 hover:bg-red-50 px-2 rounded transition">
                                <div class="text-sm font-medium text-slate-700">${c.name}</div>
                                <div class="text-sm font-bold text-red-600">₹${c.dues}</div>
                            </div>
                        `;
                    });
                }
            }
        };

        const router = {
            navigate(viewId) {
                document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                const target = document.getElementById(viewId);
                if(target) {
                    target.classList.remove('hidden');
                    document.querySelectorAll('.nav-item').forEach(el => {
                        el.classList.toggle('bg-slate-800', el.dataset.target === viewId);
                        el.classList.toggle('text-white', el.dataset.target === viewId);
                    });
                    
                    if(viewId === 'dashboard') app.renderDashboard();
                    if(viewId === 'customers') customerManager.renderList();
                    if(viewId === 'orders') orderManager.render();
                    if(viewId === 'billing') billingManager.init();
                    if(viewId === 'settings') settingsManager.render();
                    if(viewId === 'expenses') expenseManager.render();
                    if(viewId === 'reports') reportManager.init();
                    
                    if(window.innerWidth < 768) {
                        document.getElementById('sidebar').classList.add('-translate-x-full');
                        document.getElementById('sidebarOverlay').classList.add('hidden');
                    }
                }
            }
        };

        // --- CUSTOMER MANAGER ---
        const customerManager = {
            renderList() {
                const term = document.getElementById('customerSearch').value.toLowerCase();
                const sort = document.getElementById('customerSort').value;
                const tbody = document.getElementById('customerTableBody');
                tbody.innerHTML = '';
                
                let list = store.data.customers.filter(c => c.name.toLowerCase().includes(term) || c.phone.includes(term));
                
                if(sort === 'name') list.sort((a,b) => a.name.localeCompare(b.name));
                else if(sort === 'dues_high') list.sort((a,b) => b.dues - a.dues);
                else if(sort === 'dues_low') list.sort((a,b) => a.dues - b.dues);

                list.forEach(c => {
                    const hasCustomRates = c.customRates && Object.keys(c.customRates).length > 0;
                    const rateBadge = hasCustomRates ? `<span class="ml-2 bg-purple-100 text-purple-700 text-[10px] font-bold px-1.5 py-0.5 rounded" title="Has Custom Rates">%</span>` : '';
                    
                    // Color coding for dues in list
                    const duesColor = c.dues > 1000 ? 'text-red-600 bg-red-50' : (c.dues > 0 ? 'text-orange-600' : 'text-green-600');

                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-slate-50 transition border-b border-slate-50";
                    tr.innerHTML = `
                        <td class="p-4">
                            <div class="font-bold text-slate-800 flex items-center">${c.name} ${rateBadge}</div>
                            <div class="text-xs text-slate-400 font-mono">${c.id}</div>
                        </td>
                        <td class="p-4 text-slate-600">
                            <div>${c.phone}</div>
                            <div class="text-xs text-slate-400 truncate w-32">${c.address || '-'}</div>
                        </td>
                        <td class="p-4 text-right">
                            <span class="font-bold px-2 py-1 rounded ${duesColor}">₹${c.dues}</span>
                        </td>
                        <td class="p-4 text-center"><span class="px-2 py-1 rounded-full text-xs font-bold bg-green-100 text-green-700">Active</span></td>
                        <td class="p-4 text-right flex justify-end gap-2">
                            <button onclick="customerManager.openRates('${c.id}')" class="text-purple-600 bg-purple-50 hover:bg-purple-100 p-2 rounded-lg text-xs font-bold">Rates</button>
                            <button onclick="customerManager.edit('${c.id}')" class="text-blue-600 bg-blue-50 hover:bg-blue-100 p-2 rounded-lg"><i class="fas fa-edit"></i></button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            },
            openModal() {
                document.getElementById('customerModal').classList.remove('hidden');
                document.getElementById('modalTitle').innerText = 'Add New Customer';
                document.getElementById('custId').value = '';
                document.getElementById('custName').value = '';
                document.getElementById('custPhone').value = '';
                document.getElementById('custAddress').value = '';
                document.getElementById('dupWarning').classList.add('hidden');
            },
            closeModal() { document.getElementById('customerModal').classList.add('hidden'); },
            checkDuplicate(phone) {
                const match = store.data.customers.find(c => c.phone === phone && c.id !== document.getElementById('custId').value);
                const warn = document.getElementById('dupWarning');
                if (match) warn.classList.remove('hidden'); else warn.classList.add('hidden');
            },
            save() {
                const id = document.getElementById('custId').value;
                const name = document.getElementById('custName').value;
                const phone = document.getElementById('custPhone').value;
                const address = document.getElementById('custAddress').value;
                
                if(!name || !phone) return showToast("Name and Phone required", 'error');

                if (id) {
                    const idx = store.data.customers.findIndex(c => c.id === id);
                    if(idx !== -1) store.data.customers[idx] = { ...store.data.customers[idx], name, phone, address };
                } else {
                    const newId = 'C' + (1000 + store.data.customers.length + 1);
                    store.data.customers.push({ id: newId, name, phone, address, dues: 0, status: 'Active', customRates: {} });
                }
                store.save('customers');
                this.closeModal();
                this.renderList();
                showToast('Customer Saved Successfully');
            },
            edit(id) {
                const c = store.data.customers.find(c => c.id === id);
                if(!c) return;
                this.openModal();
                document.getElementById('modalTitle').innerText = 'Edit Customer';
                document.getElementById('custId').value = c.id;
                document.getElementById('custName').value = c.name;
                document.getElementById('custPhone').value = c.phone;
                document.getElementById('custAddress').value = c.address;
            },
            openRates(id) {
                const c = store.data.customers.find(c => c.id === id);
                document.getElementById('rateModal').classList.remove('hidden');
                document.getElementById('rateCustName').innerText = c.name;
                document.getElementById('rateCustId').value = c.id;
                const container = document.getElementById('rateInputs');
                container.innerHTML = '';
                
                store.data.products.forEach(p => {
                    const currentRate = (c.customRates && c.customRates[p.id]) ? c.customRates[p.id] : '';
                    container.innerHTML += `
                        <div class="flex justify-between items-center bg-slate-50 p-3 rounded">
                            <div>
                                <div class="font-bold text-sm">${p.name}</div>
                                <div class="text-xs text-slate-400">Std: ₹${p.price}</div>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-xs text-slate-500">Rate: ₹</span>
                                <input id="rate_${p.id}" type="number" value="${currentRate}" placeholder="Std" class="w-20 border rounded p-1 text-center text-sm">
                            </div>
                        </div>
                    `;
                });
            },
            saveRates() {
                const cid = document.getElementById('rateCustId').value;
                const c = store.data.customers.find(x => x.id === cid);
                if(!c.customRates) c.customRates = {};
                
                store.data.products.forEach(p => {
                    const val = document.getElementById(`rate_${p.id}`).value;
                    if(val && val !== '') c.customRates[p.id] = parseFloat(val);
                    else delete c.customRates[p.id];
                });
                
                store.save('customers');
                document.getElementById('rateModal').classList.add('hidden');
                showToast('Rates Updated');
                this.renderList();
            }
        };

        // --- ORDER MANAGER ---
        const orderManager = {
            mode: 'distribute',
            setMode(mode) {
                this.mode = mode;
                this.render();
            },
            render() {
                document.getElementById('printDate').innerText = new Date().toLocaleDateString();
                const h = document.getElementById('routeHeaderRow');
                h.innerHTML = '<th class="p-4 w-1/3">Customer</th>' + store.data.products.map(p => `<th class="p-4 w-24 text-center">${p.name}</th>`).join('') + '<th class="p-4 text-center no-print">Status</th>';
                
                const tbody = document.getElementById('orderTableBody');
                tbody.innerHTML = '';
                let count = 0;
                
                store.data.customers.forEach(c => {
                    count++;
                    const inputs = store.data.products.map(p => {
                         return `<td class="p-4 text-center"><input type="number" id="ord_${c.id}_${p.id}" min="0" class="w-16 border border-slate-300 rounded text-center py-1 bg-slate-50 focus:bg-white quantity-input" data-pid="${p.id}" placeholder="0" oninput="orderManager.updateTotals()"></td>`
                    }).join('');

                    const status = this.mode === 'distribute' 
                        ? `<button class="w-full text-xs font-bold py-1.5 rounded bg-slate-100 text-slate-600 hover:bg-green-100 hover:text-green-700 transition" onclick="this.classList.toggle('bg-green-100'); this.classList.toggle('text-green-700'); this.innerText = this.innerText==='Pending'?'Done':'Pending'">Pending</button>`
                        : `<span class="text-xs text-slate-400">Scheduled</span>`;

                    const tr = document.createElement('tr');
                    tr.className = "border-b border-slate-50";
                    tr.innerHTML = `
                        <td class="p-4">
                            <div class="font-bold text-slate-700">${c.name}</div>
                            <div class="text-xs text-slate-500">${c.address || ''}</div>
                        </td>
                        ${inputs}
                        <td class="p-4 text-center w-24 no-print">${status}</td>
                    `;
                    tbody.appendChild(tr);
                });
                
                document.getElementById('totalOrdersCount').innerText = count;
                this.updateTotals();
            },
            updateTotals() {
                const totals = {};
                store.data.products.forEach(p => totals[p.id] = 0);
                
                document.querySelectorAll('.quantity-input').forEach(input => {
                    const pid = input.dataset.pid;
                    const val = parseInt(input.value) || 0;
                    if(totals[pid] !== undefined) totals[pid] += val;
                });
                
                const tfoot = document.getElementById('orderTableFooter');
                let footerHtml = '<tr class="bg-slate-100"><td class="p-4 text-right">Total Load:</td>';
                store.data.products.forEach(p => {
                    footerHtml += `<td class="p-4 text-center font-bold text-blue-600">${totals[p.id]} ${p.unit || ''}</td>`;
                });
                footerHtml += '<td class="no-print"></td></tr>';
                tfoot.innerHTML = footerHtml;
            },
            fillYesterday() {
                if(!confirm("Overwrite current entries with last order values?")) return;
                store.data.customers.forEach(c => {
                    const lastOrder = store.data.orders
                        .filter(o => o.customerId === c.id)
                        .sort((a,b) => new Date(b.date) - new Date(a.date))[0];
                    if(lastOrder) {
                        lastOrder.items.forEach(item => {
                            const prod = store.data.products.find(p => p.name === item.name);
                            if(prod) {
                                const input = document.getElementById(`ord_${c.id}_${prod.id}`);
                                if(input) input.value = item.quantity;
                            }
                        });
                    }
                });
                this.updateTotals();
                showToast("Filled from history");
            },
            saveAll() {
                const date = new Date().toISOString().split('T')[0];
                let savedCount = 0;

                store.data.customers.forEach(c => {
                    const items = [];
                    let total = 0;
                    store.data.products.forEach(p => {
                        const q = document.getElementById(`ord_${c.id}_${p.id}`).value;
                        if(q > 0) {
                            const price = (c.customRates && c.customRates[p.id]) ? c.customRates[p.id] : p.price;
                            items.push({ name: p.name, quantity: parseInt(q), price: price });
                            total += parseInt(q) * price;
                        }
                    });

                    if(items.length > 0) {
                        store.data.orders.push({
                            id: `ORD-${Date.now()}-${c.id}`,
                            customerId: c.id,
                            customerName: c.name,
                            date: date,
                            items: items,
                            total: total
                        });
                        const cust = store.data.customers.find(x => x.id === c.id);
                        if(cust) cust.dues += total;
                        savedCount++;
                    }
                });

                if(savedCount > 0) {
                    store.save('orders');
                    store.save('customers');
                    showToast(`Saved ${savedCount} orders. Dues updated.`);
                    app.renderDashboard();
                    document.querySelectorAll('#orderTableBody input').forEach(i => i.value = '');
                    this.updateTotals();
                } else {
                    showToast("No quantities entered", 'error');
                }
            }
        };

        // --- BILLING MANAGER ---
        const billingManager = {
            init() {
                this.renderDropdowns();
                this.renderDues();
                this.renderHistory();
            },
            renderDropdowns() {
                const paySel = document.getElementById('payCustomer');
                const invSel = document.getElementById('invoiceCustomer');
                const repSel = document.getElementById('repCustomer');
                
                let opts = '<option value="">Select Customer</option>';
                store.data.customers.forEach(c => opts += `<option value="${c.id}">${c.name}</option>`);
                
                paySel.innerHTML = opts;
                invSel.innerHTML = opts;
                repSel.innerHTML = opts;

                // Employee Dropdown for Collection
                const colSel = document.getElementById('payCollector');
                colSel.innerHTML = '<option value="">-- Self / Owner --</option>';
                store.data.employees.forEach(e => colSel.innerHTML += `<option value="${e}">${e}</option>`);
            },
            renderDues() {
                // Same logic but no table in this updated view for saving space, rely on History table or Customers list
            },
            renderHistory() {
                const tbody = document.getElementById('paymentHistoryBody');
                tbody.innerHTML = '';
                [...store.data.payments].sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0, 50).forEach(p => {
                    const c = store.data.customers.find(x => x.id === p.customerId);
                    const collector = p.collectedBy ? `<div class="text-xs text-blue-600"><i class="fas fa-user-tag mr-1"></i>${p.collectedBy}</div>` : '';
                    const note = p.note ? `<div class="text-xs text-slate-400 italic">"${p.note}"</div>` : '';
                    
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-slate-50 border-b";
                    tr.innerHTML = `
                        <td class="p-4 text-slate-500 text-xs">${p.date}</td>
                        <td class="p-4 font-medium">${c?c.name:'Unknown'}</td>
                        <td class="p-4">
                            ${collector}
                            ${note}
                        </td>
                        <td class="p-4 text-right font-bold text-green-600">₹${p.amount}</td>
                    `;
                    tbody.appendChild(tr);
                });
            },
            recordPayment(e) {
                e.preventDefault();
                const custId = document.getElementById('payCustomer').value;
                const amount = parseFloat(document.getElementById('payAmount').value);
                const date = document.getElementById('payDate').value;
                const collector = document.getElementById('payCollector').value;
                const note = document.getElementById('payNote').value;
                
                if(!custId || amount <= 0) return showToast('Invalid details', 'error');

                const c = store.data.customers.find(c => c.id === custId);
                if(c) {
                    c.dues -= amount;
                    store.data.payments.push({ id: Date.now(), customerId: custId, amount: amount, date: date, collectedBy: collector, note: note });
                    store.save('customers');
                    store.save('payments');
                    showToast('Payment Recorded');
                    document.getElementById('payAmount').value = '';
                    document.getElementById('payNote').value = '';
                    this.init();
                    app.renderDashboard();
                }
            },
            generateInvoice() {
                const cid = document.getElementById('invoiceCustomer').value;
                if(!cid) return showToast('Select a customer', 'error');
                
                const c = store.data.customers.find(x => x.id === cid);
                const orders = store.data.orders.filter(o => o.customerId === cid).sort((a,b) => new Date(b.date) - new Date(a.date));
                const payments = store.data.payments.filter(p => p.customerId === cid).sort((a,b) => new Date(b.date) - new Date(a.date));
                
                document.getElementById('billing').classList.add('hidden');
                document.getElementById('invoice-view').classList.remove('hidden');
                
                document.getElementById('inv-cust-name').innerText = c.name;
                document.getElementById('inv-date').innerText = `Date: ${new Date().toLocaleDateString()}`;
                
                let html = `<div class="mb-4 text-right font-bold text-xl ${c.dues>0?'text-red-600':'text-green-600'} border p-4 inline-block float-right rounded">Current Dues: ₹${c.dues}</div>
                            <h3 class="font-bold border-b mb-2">Recent Transactions</h3>
                            <table class="w-full text-sm text-left mb-8">
                            <thead class="bg-slate-100"><tr><th class="p-2">Date</th><th class="p-2">Type</th><th class="p-2">Details</th><th class="p-2 text-right">Amount</th></tr></thead><tbody>`;
                
                const allTx = [
                    ...orders.map(o => ({ date: o.date, type: 'Order', desc: o.items.map(i=>`${i.quantity} ${i.name}`).join(', '), amt: o.total })),
                    ...payments.map(p => ({ date: p.date, type: 'Payment', desc: 'Cash/Online', amt: -p.amount }))
                ].sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0, 15);
                
                allTx.forEach(t => {
                    html += `<tr>
                        <td class="p-2 border-b">${t.date}</td>
                        <td class="p-2 border-b font-bold ${t.type==='Payment'?'text-green-600':'text-slate-600'}">${t.type}</td>
                        <td class="p-2 border-b">${t.desc}</td>
                        <td class="p-2 border-b text-right">${t.amt > 0 ? '₹'+t.amt : '-₹'+Math.abs(t.amt)}</td>
                    </tr>`;
                });
                
                html += `</tbody></table><p class="text-center text-xs text-slate-400 mt-8">Thank you for your business!</p>`;
                document.getElementById('invoice-content').innerHTML = html;
                
                const waText = `Hello ${c.name}, your current outstanding balance is ₹${c.dues}.`;
                const waLink = `https://wa.me/91${c.phone}?text=${encodeURIComponent(waText)}`;
                document.getElementById('whatsappShareBtn').onclick = () => window.open(waLink, '_blank');
            }
        };

        // --- EXPENSE MANAGER ---
        const expenseManager = {
            render() {
                this.renderDropdowns();
                this.renderLog();
            },
            renderDropdowns() {
                const s = document.getElementById('expCategory');
                s.innerHTML = '';
                store.data.expenseCategories.forEach(c => s.innerHTML += `<option value="${c}">${c}</option>`);

                const emp = document.getElementById('expEmployee');
                emp.innerHTML = '<option value="">-- Other / Vendor --</option>';
                store.data.employees.forEach(e => emp.innerHTML += `<option value="${e}">${e}</option>`);
            },
            renderLog() {
                const tbody = document.getElementById('expenseTableBody');
                tbody.innerHTML = '';
                [...store.data.expenses].sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(e => {
                    const employeeTag = e.employeeId ? `<span class="ml-2 text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded"><i class="fas fa-user mr-1"></i>${e.employeeId}</span>` : '';
                    
                    const tr = document.createElement('tr');
                    tr.className = "border-b hover:bg-slate-50";
                    tr.innerHTML = `
                        <td class="p-4 text-slate-500">${e.date}</td>
                        <td class="p-4 font-medium">
                            <div class="text-slate-800">${e.title}</div>
                            <div class="mt-1">
                                <span class="text-xs bg-slate-100 px-2 py-1 rounded text-slate-500 border">${e.category}</span>
                                ${employeeTag}
                            </div>
                        </td>
                        <td class="p-4 text-right font-bold text-red-500">₹${e.amount}</td>
                    `;
                    tbody.appendChild(tr);
                });
            },
            add(e) {
                e.preventDefault();
                const title = document.getElementById('expTitle').value;
                const amt = parseFloat(document.getElementById('expAmount').value);
                const cat = document.getElementById('expCategory').value;
                const date = document.getElementById('expDate').value;
                const emp = document.getElementById('expEmployee').value;
                
                if(!title || amt <= 0) return showToast('Invalid details', 'error');
                
                store.data.expenses.push({ id: Date.now(), title, amount: amt, category: cat, date, employeeId: emp });
                store.save('expenses');
                showToast('Expense Added');
                document.getElementById('expTitle').value = '';
                document.getElementById('expAmount').value = '';
                this.renderLog();
            }
        };

        // --- REPORT MANAGER ---
        const reportManager = {
            init() { billingManager.renderDropdowns(); },
            toggleInputs() {
                const t = document.getElementById('reportType').value;
                document.getElementById('custInput').classList.toggle('hidden', t !== 'customer_monthly');
            },
            generate() {
                const type = document.getElementById('reportType').value;
                const start = document.getElementById('repStartDate').value;
                const end = document.getElementById('repEndDate').value;
                const cid = document.getElementById('repCustomer').value;
                const out = document.getElementById('reportOutput');
                
                if(type === 'financial') {
                    const rev = store.data.orders.filter(o => o.date >= start && o.date <= end).reduce((sum, o) => sum + o.total, 0);
                    const exp = store.data.expenses.filter(e => e.date >= start && e.date <= end).reduce((sum, e) => sum + e.amount, 0);
                    const profit = rev - exp;
                    out.innerHTML = `
                        <h3 class="font-bold text-center text-lg mb-4">P&L Statement (${start} to ${end})</h3>
                        <div class="grid grid-cols-3 gap-4 text-center">
                            <div class="bg-green-50 p-4 rounded"><div class="text-xs text-green-800">Revenue</div><div class="text-xl font-bold text-green-600">₹${rev}</div></div>
                            <div class="bg-red-50 p-4 rounded"><div class="text-xs text-red-800">Expenses</div><div class="text-xl font-bold text-red-600">₹${exp}</div></div>
                            <div class="bg-blue-50 p-4 rounded"><div class="text-xs text-blue-800">Net Profit</div><div class="text-xl font-bold ${profit>=0?'text-green-600':'text-red-600'}">₹${profit}</div></div>
                        </div>`;
                } else {
                    let items = store.data.orders.filter(o => o.date >= start && o.date <= end);
                    if(type === 'customer_monthly') items = items.filter(o => o.customerId === cid);
                    
                    if(items.length === 0) return out.innerHTML = `<div class="text-center text-slate-400">No records.</div>`;
                    
                    let html = `<h3 class="font-bold mb-4">Details</h3><table class="w-full text-sm"><thead class="bg-slate-50 text-left"><tr><th class="p-2">Date</th><th class="p-2">Desc</th><th class="p-2 text-right">Amt</th></tr></thead><tbody>`;
                    let total = 0;
                    items.forEach(i => {
                        html += `<tr><td class="p-2 border-b">${i.date}</td><td class="p-2 border-b">${type==='day_book'?i.customerName:''} ${i.items.map(x=>`${x.quantity}${x.name.charAt(0)}`).join(',')}</td><td class="p-2 border-b text-right">₹${i.total}</td></tr>`;
                        total += i.total;
                    });
                    html += `</tbody><tfoot><tr><td colspan="2" class="p-2 font-bold text-right">Total:</td><td class="p-2 font-bold text-right">₹${total}</td></tr></tfoot></table>`;
                    out.innerHTML = html;
                }
            }
        };

        // --- SETTINGS & DATA MANAGER ---
        const settingsManager = {
            render() {
                // Products
                const c = document.getElementById('productSettingsList');
                c.innerHTML = '';
                store.data.products.forEach(p => {
                    c.innerHTML += `
                        <div class="bg-slate-50 p-4 rounded-lg border border-slate-200 relative">
                            <button onclick="settingsManager.delProduct('${p.id}')" class="absolute top-2 right-2 text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button>
                            <div class="font-bold text-slate-700 mb-2">${p.name}</div>
                            <div class="flex items-center gap-2">
                                <span class="text-sm">₹</span>
                                <input type="number" class="w-full border rounded p-1 text-sm" value="${p.price}" onchange="settingsManager.updatePrice('${p.id}', this.value)">
                            </div>
                        </div>`;
                });

                // Employees
                const e = document.getElementById('employeeList');
                e.innerHTML = '';
                store.data.employees.forEach((emp, index) => {
                    e.innerHTML += `
                        <div class="flex justify-between items-center bg-slate-50 p-2 rounded border">
                            <span class="font-medium text-sm">${emp}</span>
                            <button onclick="settingsManager.delEmployee(${index})" class="text-red-400 hover:text-red-600"><i class="fas fa-times"></i></button>
                        </div>
                    `;
                });
            },
            addProduct() {
                const name = prompt("Product Name:");
                const price = prompt("Standard Price (₹):");
                if(name && price) {
                    const id = 'p' + Date.now();
                    store.data.products.push({ id, name, price: parseFloat(price), unit: 'Unit' });
                    store.save('products');
                    this.render();
                    showToast('Product Added');
                }
            },
            delProduct(id) {
                if(confirm('Delete product?')) {
                    store.data.products = store.data.products.filter(p => p.id !== id);
                    store.save('products');
                    this.render();
                }
            },
            updatePrice(id, val) {
                const p = store.data.products.find(x => x.id === id);
                if(p) { p.price = parseFloat(val); store.save('products'); showToast('Price Updated'); }
            },
            addEmployee() {
                const name = prompt("Enter Employee Name:");
                if(name) {
                    store.data.employees.push(name);
                    store.save('employees');
                    this.render();
                    showToast('Employee Added');
                }
            },
            delEmployee(index) {
                if(confirm('Remove this employee?')) {
                    store.data.employees.splice(index, 1);
                    store.save('employees');
                    this.render();
                }
            }
        };

        const dataManager = {
            backup() {
                const blob = new Blob([JSON.stringify(store.data)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `dairy_backup_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
            },
            restore(input) {
                const file = input.files[0];
                if(file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            Object.keys(data).forEach(k => localStorage.setItem(`dairy_${k}`, JSON.stringify(data[k])));
                            showToast('Data Restored! Reloading...');
                            setTimeout(() => location.reload(), 1500);
                        } catch(err) { showToast('Invalid File', 'error'); }
                    };
                    reader.readAsText(file);
                }
            }
        };

        window.onload = () => document.getElementById('username').focus();
    </script>
</body>
</html>